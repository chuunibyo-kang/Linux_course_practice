# 1、安全控制

## 1.1、重置root密码

在CentOS7中，若忘记了root密码导致无法开机，需要使用一些特别的方法来修改root密码

### 1.1.1、进入GRUB2编辑模式修改GRUB2文件

在启动系统，并在GRUB2菜单选择中，选中第一项，按==e==进入编辑模式。

![截屏2021-11-22 上午9.10.10](/Users/lamchingkeung/Library/Application Support/typora-user-images/截屏2021-11-22 上午9.10.10.png)

找到Linux16开头的那段，移至行尾，输入==空格==，再输入==`rd.break`==，最后按==ctrl+x==进入到shell中。

![截屏2021-11-22 下午8.31.45](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.31.45.png)

![截屏2021-11-22 上午9.21.38](/Users/lamchingkeung/Library/Application Support/typora-user-images/截屏2021-11-22 上午9.21.38.png)

### 1.1.2、重新挂载root目录

输入==`whoami`==命令后发现无法当前不是真正的root用户，这时候就需要切换root目录来了

<img src="/Users/lamchingkeung/Library/Application Support/typora-user-images/截屏2021-11-22 下午12.00.26.png" alt="截屏2021-11-22 下午12.00.26" style="zoom:200%;" />

使用==`mount`==命令，可以看到root目录sysroot为只读模式（read only，简写为ro），使用==`mount -o remount,rw /sysroot `==，重新挂载系统分区，再输入==`chroot /sysroot`==改变根目录，可以看到切换了root目录后用户名也发生了变化，用户名后的符号从/#变成了#，变成了真正的root用户，输入==`whoami`==命令后可以得知该用户是root

```shell
#mount -o remount是重新挂载，而rw则是将挂载模式切换为可读写
```

<img src="/Users/lamchingkeung/Library/Application Support/typora-user-images/截屏2021-11-22 上午11.57.54.png" alt="截屏2021-11-22 上午11.57.54" style="zoom:200%;" />

### 1.1.3、更改root密码

进入了真正的root模式，可直接使用==`passwd root`==命令来更改root密码，第一次输入新密码会提示你的密码不够安全，需要大于8位，可以直接忽视（==在现实工作环境中，Linux不要设置弱密码==）。

![截屏2021-11-23 下午1.25.18](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-23 下午1.25.18.png)

### 1.1.4、SELinux放行

如果开启了SELinux，这种更改行为是不被允许的，直接重启会导致当前的更改无法生效，即“白干了”，所以需要用一些“手法”让SELinux放行，此处使用命令==`touch /.autorelabel`==来达到放行的效果。

<img src="/Users/lamchingkeung/Library/Application Support/typora-user-images/截屏2021-11-22 下午7.22.32.png" alt="截屏2021-11-22 下午7.22.32" style="zoom:150%;" />

### 1.1.5、重启与验证

在sh-4.2下是无法直接重启的，需要退回到上一个用户下才能进行重启操作，重启后会有一个很漫长的初始化过程，请耐心等待。

<img src="/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午7.26.42.png" alt="截屏2021-11-22 下午7.26.42" style="zoom:150%;" />

<img src="/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午7.28.46.png" alt="截屏2021-11-22 下午7.28.46" style="zoom:150%;" />

进去后，输入了修改后的简单密码，成功登录。

<img src="/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午7.30.05.png" alt="截屏2021-11-22 下午7.30.05" style="zoom: 150%;" />



## 1.2、为GRUB2菜单加防编辑密码

既然可以通过GRUB2的编辑模式来达到修改root密码，我们也可以通过给GRUB2菜单“加把锁”来达到防篡改。

### 1.2.1、生成复杂密文

进入终端，使用==`grub2-mkpasswd-pbkdf2`==获取一串使用PBKDF2算法加密的超长字符串，图中用括号括起来的那一段便是密文

![截屏2021-11-22 下午7.47.53](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午7.47.53.png)

### 1.2.2、修改grub文件

使用==`vim /boot/grub2/grub.cfg`==编辑grub文件，在87行后添加两行代码

```shell
#username为自己设置的用户名
set superusers="xxxxx"
#格式：password_pbkdf2 上一行设置的用户名 你的密钥
password_pbkdf2 username grub.pbkdf2.shaxxxx.xxxxxx
```

![截屏2021-11-22 下午7.56.17](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午7.56.17.png)

### 1.2.3、验证

保存并退出grub文档后，再次进入GRUB2的编辑模式，然后发现需要输入密码，如果输入错误则会弹回GRUB2选择界面，输入正确则进入编辑模式。



![截屏2021-11-22 下午7.59.36](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午7.59.36.png)

## 1.3、修复MBR

==MBR==是==master boot record==的缩写，又称主引导扇区，

MBR文件包含==bootloader==、==partition table==、==magic number==，总计==512字节==，本次实验以破坏bootloader文件的环境下，修复MBR。

==⚠️注意！此处要对扇区文件进行备份才能做！如果没有备份，要么重装！要么恢复快照！==

### 1.3.1、MBR文件的备份与破坏

先做好扇区文件的备份，然后再破坏文件。

```shell
#dd是用于复制文件冰对原文件的内容进行转换和格式化处理的命令
#if为输入接口，of为输出文件接口，count为指定的区块数，bs为制定的字节数
#该命令用于备份MBR文件
dd if=/dev/sda of=/root/mbr.bak count=1 bs=512
#该命令用于破坏MBR文件，dev/zero用于生成一个特定大小的文件，覆盖sda目录
dd if=/dev/zero of=/dev/sda count=1 bs=446
```

![截屏2021-11-22 下午8.11.46](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.11.46.png)

### 1.3.2、挂载光盘进入急救模式

重启后发现无法正常启动，卡在开机自检的画面，这时候需要挂载系统镜像然后再次重启。

![截屏2021-11-22 下午8.16.03](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.16.03.png)

![截屏2021-11-22 下午8.16.49](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.16.49.png)

重启后进入光盘引导界面，选中==Troubleshooting==。

![截屏2021-11-22 下午8.14.43](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.14.43.png)

选择救援模式 ==Rescue a Centos system==，然后点击==Enter==键安装救援模式。

![截屏2021-11-22 下午8.17.37](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.17.37.png)

![截屏2021-11-22 下午8.18.01](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.18.01.png)

安装完之后，提示你输入1可以对你的系统进行更改，此处选1

![截屏2021-11-22 下午8.18.35](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.18.35.png)

### 1.3.3、恢复MBR文件

此处提示当前系统挂在目录为/mnt/sysimage，可以使用命令==`chroot /mnt /sysimage`==进入root环境![截屏2021-11-22 下午8.18.57](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.18.57.png)

此处执行以下命令来达到修复MBR文件

```shell
chroot /mnt/sysimage #更改root目录
grub2-install /dev/sda #执行grub2安装，安装目录为/dev/sda
sync#强制将被改写的内容写入磁盘
exit#当root路径在chroot无法重启，所以需要退出到原本的环境才能重启
reboot
```

![截屏2021-11-22 下午8.22.16](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.22.16.png)

重启后进入GRUB2的界面，修复成功。

![image-20211123150204141](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211123150204141.png)



## 1.4、修复GRUB

GRUB文件丢失，会进入GRUB界面

==⚠️注意，GRUB2文件复杂，最好先进行备份然后再进行实验==

### 1.4.1、GRUB文件的备份与破坏

```shell
# 备份
mkdir grub2.bak
chmod 600 grub2.bak/ #更改文件夹权限 
cp -rp /boot/grub2/* ./grub2.bak/#将grub文件复制到跟目录下 
# 破坏
rm /boot/grub2/grub.cfg #删除grub.cfg
rm:是否删除普通文件 "/boot/grub2/grub.cfg"?y 
```

![截屏2021-11-22 下午8.45.10](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午8.45.10.png)

此处使用==`fdisk -l`==查看boot分区，可以看到分了三个区

![截屏2021-11-23 下午3.20.21](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-23 下午3.20.21.png)

可以看到dev下sda3这个boot分区没有独立出来，可以用于接下来的手动引导。

![截屏2021-11-23 上午12.16.18](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-23 上午12.16.18.png)

### 1.4.2、手动引导GRUB2

重启之后发现进入了grub界面，这时候需要手动引导进入系统。

![截屏2021-11-22 下午9.07.25](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午9.07.25.png)

是用ls命令查看以下4个磁盘，发现只有(hd0,msdos1)内有可以用于手动引导的文件，而(hd0,msdos3)里面的能看到grub文件被破坏前做好的备份文件。

![截屏2021-11-22 下午11.36.57](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-22 下午11.36.57.png)

用以下的命令进行手动引导

```shell
#“set root=”用于指定boot分区
  set root=‘hd0,msdos1’ 
#“Linux16 文件名”用于指定内核，“root=/.../...”用于真正的根分区，ro为read only
  linux16 /vmlinuz-3.10.0-1160.el7.x86_64 ro root=/dev/sda3
#initrd16用于指定初始化镜像
  initrd16 /initramfs-3.10.0-1160.el7.x86_64.img
 #重启
 boot
```

![截屏2021-11-23 上午12.20.37](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-23 上午12.20.37.png)

### 1.4.3、恢复grub文件

手动引导后能够进入到登录界面。

![截屏2021-11-23 上午12.21.36](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-23 上午12.21.36.png)

将提前备份好的文件恢复到原本目录中，然后重启验证。

命令为==`cp ./grub2.bak/grub.cfg /boot/grub2`==

![截屏2021-11-23 上午12.26.25](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-23 上午12.26.25.png)

可以看出手动引导后恢复GRUB2文件是可行的。

![截屏2021-11-23 上午12.26.51](/Users/lamchingkeung/Desktop/safe_control_secreenshot/截屏2021-11-23 上午12.26.51.png)



# 2、DHCP服务器的搭建

## 2.1、初期工作

### 2.1.1、DHCP服务的安装

在配置DHCP服务前，首先要确保系统安装了DHCP服务。

使用==`rpm -qa dhcp`==命令来查看是否安装了DHCP，如果安装了，则会返回版本号，如果没安装，则什么都不会显示。

![截屏2021-11-23 下午8.27.18](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 下午8.27.18.png)

![截屏2021-11-23 下午8.28.40](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 下午8.28.40.png)

安装的方法也有很多种

（1）使用rpm安装

挂载光盘镜像，进入挂载镜像，查找有关DHCP的RPM包，然后使用==`rpm -ivh 包全名`==命令安装，然后使用==`rpm -qa dhcp`==命令检查是否安装上。

![截屏2021-11-23 下午8.37.29](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 下午8.37.29.png)

（2）使用yum安装

这个方法比较简单，但这个方法有几个==前提==：

1、==有网络（这是基础）==

2、==提前修改了yum源（修改了yum源能提升yum的使用体验）==

<del>当然，你对你的网络有信心，可以不改yum源</del>

使用==`yum install dhcp`==命令，等待安装完成，还能顺便升级其他配套的软件

![截屏2021-11-23 上午8.34.48](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午8.34.48.png)

### 2.1.2、修改自身网络配置

装完了DHCP服务后，还需要修改自身的网络设置

首先使用==`find /etc -type f -name "*ens33*"`==命令找出网卡的配置文件，然后使用==`vim`==命令打开该配置文件

![截屏2021-11-23 上午8.40.59](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午8.40.59.png)

打开后如果以前没有配置过的话，配置的最后一行是ONBOOT，而且BOOTPROTO应该为dhcp，成为DHCP服务器，需要本机为静态地址，所以要将==将BOOTPROTO改成static==，==增写本机的固定IP地址、网关地址==，DNS可以选填，填写完后保存退出。

<img src="/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.05.17.png" alt="截屏2021-11-23 上午11.05.17"  />

回到终端，使用==`systemctl restart network.service`==命令重启网络，使用==`route -n`==和==`ifconfig`==查看修改是否生效

![截屏2021-11-23 上午8.49.23](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午8.49.23.png)

### 2.1.3、寻找DHCP配置文件

使用==`find /* -type -name "dhcp.conf"`==命令查找DHCP配置文件，找到后使用==`vim`==命令编辑该文件

![截屏2021-11-23 上午8.35.44](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午8.35.44.png)

在这个页面中可以看到，这个conf文件提示让我们去查看==usr/share/doc/dhcp*/dhcpd.conf.example==这个DHCP配置模版文件。

![截屏2021-11-23 上午8.36.02](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午8.36.02.png)

此处我们选择直接覆盖原文件，命令为==`cp -p /usr/share/doc/dhcp-4.2.5/dhcpd.conf.example`==，使用==`cat /etc/dhcp/dhcpd.conf`==命令检查dhcpd.conf是否覆盖成功。

![截屏2021-11-23 上午8.52.03](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午8.52.03.png)

到这里，DHCP搭建的初期工作已经完成了，接下来则是==按需修改dhcpd.conf==来达到想要的效果了。

## 2.2、DHCP自动分配IP

### 2.2.1、修改DHCP配置文件

dhcp.conf.example文件内自带的注释非常人性化<del>（如果能看懂英语的话）</del>。

（1）修改作用域

使用==`vim /etc/dhcp/dhcpd.conf`==打开dhcpd.conf文件，下翻到如图所示的这一段配置，可以看到这一段是用于配置作用域的。

![截屏2021-11-23 上午8.58.59](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午8.58.59.png)

以下是函数中的参数简介：

```shell
subnet x.x.x.x#网段 
netmask x.x.x.x#子网掩码
range [起始IP地址][结束IP地址]#指定IP地址池的范围
option domain-name-servers [IP地址] #指定DNS服务器地址
option domain-name [域名]#指定默认的域
option routers [IP地址]#指定网关
option broadcast-address [IP地址]#广播地址
default-lease-time [数字]#最小的租约期限，以秒为单位
max-lease-time [数字]#最小的租约期限，以秒为单位
```

按照自己的需求来进行更改，更改后如下图

==⚠️注意！函数里的每一条配置写完之后一定要加分号，否则更新DHCP服务会出错==

![截屏2021-11-23 上午11.09.48](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.09.48.png)

（2）重启DHCP并查看DHCP状态

使用命令==`systemctl restart dhcpd.service`==重启DHCP服务器。

使用命令==`netstat -luntp | grep dhcp`==查看DHCP状态。

![截屏2021-11-23 上午11.10.41](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.10.41.png)

### 2.2.2、验证前的工作

==如果是macOS Big Sur及以上，可以忽略这一步（因为一些特殊原因无法设置）==。

==如果是低于Big Sur版本的macOS系统以及Windows系统的虚拟机，则需要取消VMware的本地DHCP设置==。

以下为Windows的设置

![image-20211123230316126](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211123230316126.png)

### 2.2.3、Windows验证

在本地连接设置中的IPV4属性全部修改成自动获取。

![image-20211123230826951](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211123230826951.png)

使用==`ipconfig/release`==命令释放当前的IP地址

![截屏2021-11-23 上午11.15.24](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.15.24.png)

使用==`ipconfig/renew`==命令重新获取新的IP地址，可以看到DNS后缀、IP地址、网关地址、子网掩码都符合DHCP服务器的配置。

![截屏2021-11-23 上午11.16.08](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.16.08.png)

### 2.2.3、Linux验证

此处Linux验证是用kali来验证。

先使用==`dhclient -r eth0`==命令来释放当前的IP。

使用==`dhclient -d etho`==命令重新获取IP，这个命令还能看到客户端向DHCP服务器申请IP的过程（分别是==DHCPDISCOVER、DHCPOFFER、DHCPREQUES、TDHCPACK==这四条信息），符合以下这个流程图。

<img src="/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211123232007117.png" alt="image-20211123232007117" style="zoom: 67%;" />

最后是用==`ifconfig`==命令来验证是否达到了预期结果，结果显示，这些参数都符合DHCP服务器的配置。

![截屏2021-11-23 上午11.12.51](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.12.51.png)

## 2.3、DHCP手工分配IP

在公司，一些服务器是需要固定的IP地址，比如DNS服务器、OA服务器，所以这时候需要手动写入静止的IP配置，来避免DHCP造成IP地址的变动从而造成无法挽回的损失。

### 2.3.1、修改DHCP配置文件

在Windows中，我们可以使用==`ipconfig/all`==来查看MAC地址。

![截屏2021-11-23 上午11.18.52](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.18.52.png)

在Linux中，我们可以使用==`ifconfig`==查看MAC地址。

得知这些MAC地址后，回到DHCP配置的机子上，使用==`vim /etc/dhcp/dhcpd.conf`==打开dhcpd.conf文件，添加一段格式如下的配置。

```shell
#host xxx为主机名，所以该段配置是为xxx主机配置
host xxx {
	hardware [硬件类型][设备的MAC地址];#用于指定设备
	fixed-adress xxx.xxx.xxx.xxx;#写入指定的IP地址
  [option host-name "xxxxx"];#指定主机的名称
}
```

按需求，写了两个主机IP配置，上为Linux主机的配置，下为Windows配置：

![截屏2021-11-23 下午12.05.32](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 下午12.05.32.png)

![截屏2021-11-23 上午11.42.33](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.42.33.png)

### 2.3.2、Windows验证

使用==`ipconfig/renew`==命令重新获取IP，可以看到IP地址与配置文件内的相符合。

![截屏2021-11-23 上午11.45.14](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 上午11.45.14.png)

### 2.3.3、Linux验证

可以看到输入==`hostname`==命令显示的与配置文件的一致。

使用==`ifconfig`==查看IP地址，也与配置文件的一致。

![截屏2021-11-23 下午12.04.21](/Users/lamchingkeung/Desktop/dhcp_server_screenshot/截屏2021-11-23 下午12.04.21.png)

# 3、DNS服务器的搭建

## 3.1、DNS服务初始化

### 3.1.1、安装DNS

首先使用==`yum`==命令安装DNS软件包以及DNS安全包。

```shell
#bind是DNS主程序
#bind-chroot是DNS安全包，能改变默认DNS的根目录，以一种更安全的方式运行DNS
yum -y install bind bind -chroot
```

![截屏2021-11-24 上午12.12.49](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.12.49.png)

安装完毕后，使用==`ls`==命令查看三处配置文件，检查是否安装成功。

```shell
# 查看DNS主配置文件（初次安装，文件是模版文件）
ls /etc/named.conf 
# 查看解析文件，区域数据库文件（这些文件是模版文件）
ls /var/named/
# 查看chroot文件
ls /var/named/chroot/ 
```

![截屏2021-11-24 上午12.14.12](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.14.12.png)

处于安全考虑，本次DNS服务器搭建使用chroot模式，需要将相关文件转移到chroot目录中。

```shell
#将配置文件转移到chroot跟目录
cp -p /etc/named.conf /var/named/chroot/etc/ #转移DNS主配置文件
cp -p /var/named/named.* /var/named/chroot/var/named/ #转移解析文件、区域数据库文件
#查看是否转移成功
ls -l /var/named/chroot/var/named/
```

![截屏2021-11-24 上午12.15.25](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.15.25.png)

好了，到这里，DNS的安装就结束了。

### 3.1.2、启动DNS

```shell
# 设置为开机启动（重启后生效）
systemctl enable named-chroot.service
# 启动 DNS 服务
systemctl start named-chroot.service
```

直接开启DNS服务后发现出现服务器启动失败，说明配置文件出错，而下一步就是配置DNS配置文件。

![截屏2021-11-24 上午12.16.34](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.16.34.png)

### 3.1.3、DNS的初步配置

#### 3.1.3.1、配置DNS主配置文件

在配置DNS配置文件之前，先使用==`vim /etc/sysconfig/network-scripts/ifcfg-ens33`==命令编辑自己的网卡配置，要==将IP地址、子网掩码、网关地址设置成静止==。

==⚠️注意，在网卡配置中不要写入实际上能够使用的DNS，否则会导致实验失败==

![截屏2021-11-24 上午1.02.34](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.02.34.png)

使用==`vim /var/named/chroot/etc/named.conf`==查看主配置文件

![截屏2021-11-24 上午12.17.45](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.17.45.png)

打开后可以看到很多配置参数，以下是==named.conf==文件解析

```shell
options {
	listen-on port 53 { 127.0.0.1; };#指定IPV4监听端口
	listen-on-v6 port 53 { ::1; }; # 指定IPV6监听端口,::1 相当于本地回环
	directory "/var/named"; # 指定区域数据库
	dump-file "/var/named/data/cache_dump.db"; # 指定缓存数据到文件
	statistics-file "/var/named/data/named_stats.txt"; # 指定转储静态数据的文件
	memstatistics-file "/var/named/data/named_mem_stats.txt"; # 指定内存统计文件
	recursing-file "/var/named/data/named.recursing"; #指定当前递归请求到的文件
	secroots-file "/var/named/data/named.secroots"; #指定安全根的目的文件
	
	allow-query { localhost; }; #解析许可
	recursion yes; # 递归查询

	dnssec-enable yes; # DNS安全机制，防止DNS域名劫持/DNS欺骗 
	dnssec-validation yes; # 认证

	/* Path to ISC DLV key */
	bindkeys-file "/etc/named.root.key"; # 公私密钥确认

	managed-keys-directory "/var/named/dynamic";
	pid-file "/run/named/named.pid";
	session-keyfile "/run/named/session.key";
};
# 日志输出 
	logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
}; 
# 域，此处是给根做解析 
zone "." IN {
		type hint;
		file "named.ca"; # 区域数据库文件
};
# 文件包含
include "/etc/named.rfc1912.zones"; 
include "/etc/named.root.key";
```

修改==named.conf==文件，该图图中框中的地方需要做修改。

![截屏2021-11-24 上午12.29.15](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.29.15.png)

该图中框中的logging可以==选择性变为注释==，文件包含需要注释掉。

![截屏2021-11-24 上午12.29.49](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.29.49.png)

使用==`named-checkconf /var/named/chroot/etc/named.conf`==检查配置文件是否正确，返回空白正确，返回报错信息则需要检查配置文件是否正确。



![截屏2021-11-24 上午12.30.29](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.30.29.png)

使用==`systemctl start named-chroot`==开启DNS服务，没有报错则开启成功，反之则需要检查配置文件的配置是否正确。

![截屏2021-11-24 上午12.31.09](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.31.09.png)

#### 3.1.3.2、查看DNS区域数据库文件

使用==`vim /var/named/chroot/var/named/named.ca`==命令查看区域数据库文件。

![截屏2021-11-24 上午12.33.33](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.33.33.png)

![截屏2021-11-24 上午12.34.36](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.34.36.png)

#### 3.1.3.3、查看模版文件

使用==`vim /var/named/chroot/var/named/named.empty`==命令查看正向解析模版文件。
![截屏2021-11-24 上午12.35.32](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.35.32.png)

使用==`vim /var/named/chroot/var/named/named.localhost`==命令查看反向解析模版文件。

![截屏2021-11-24 上午12.36.08](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.36.08.png)

后续配置正向、反向解析文件时，可以使用以上两个模版文件。

## 3.2、部署DNS

此处自定义一个域名gudako.chaldea，需要完成以下的要求：

（1）www.gudako.chaldea解析IP地址为192.168.66.166。

（2）master做别名解析为www。

（3）192.168.66.166能够反向解析到域名。

### 3.2.1、域名正向解析

使用==`vim /var/named/chroot/etc/named.conf`==配置主配置文件，在zone"."后添加自定义的域配置。

```shell
#zone格式
#zone后的名字时域名
zone "xxxx" IN {
        type master;#可选有hint、master、slave、forward
        file "xx"#在/var/named/chroot/var/named目录下的正向解析文件
};
```

type选择==master==，file选择一个指定的zone文件，此处填入自定义的==gudako.chaldea.org==文件。

![截屏2021-11-24 上午12.45.34](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.45.34.png)

使用命令==`cd /var/named/chroot/var/named`==查看==named==文件夹下的文件。

![截屏2021-11-24 上午12.47.14](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.47.14.png)

使用命令==`cp -p named.localhost ckh.handsome.zone`==将正向解析模版文件==named.localhost==的文件名改成==gudako.chaldea.org==，然后使用==`vim ckh.handsome.zone`==编辑。

![截屏2021-11-24 上午12.48.15](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.48.15.png)

```java
/*
SOA全称Start of Authority，又称起始授权机构，它指定某主机作为该区域的权威主机，使得该主机能够对该区域文件内的写入的规则进行解析
比如test.cn. IN SOA ns.test.cn：定义负责解析test.cn.域的授权主机是ns.test.cn.
*/
[zone]IN SOA [主机名][管理员email]#设置SOA


/*
将主机名映射到IPV4地址，主机名可以详写也可以略写
比如域名叫163.com，主机名叫mail
可以直接缩写成mail IN A [IP地址]
也可以详写成mail.163.com IN A [IP地址]
*/
[hostname] IN A [IP地址]

/*
NS全称Name Server，又叫区域权威名称服务器
"test.cn. IN NS ns.test.cn.：定义域"test.cn."由DNS服务器"ns.test.cn."负责解析
*/
[zone] IN NS [主机名称]

//CNAME全程canonical name，又叫别名
[主机别名] CNAME [原主机名]
```

图中框起的地方是实际配置中需要修改的。

下图的配置转换成文字表述为：

将ns1.gudako.chaldea.设置为gudako.chaldea.域的权威服务器。

将ns1主机映射到本机IP，即本机是gudako.chaldea.区域的解析服务器。

将www主机映射到IP地址192.168.66.166。

给www主机起别名叫master。

![截屏2021-11-24 上午12.54.19](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.54.19.png)

使用命令==`named-checkzone gudako.chaldea /var/named/chroot/var/named/gudako.chaldea.org`==

检查区域配置是否出错，若返回OK，则配置无误，若报错，则需要检查配置，然后使用命令==`systemctl restart named-chroot.service`==重启DNS服务。

![截屏2021-11-24 上午1.00.40](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.00.40.png)

使用==`vim /etc/resolv.conf`==命令编辑==临时性的DNS==，如果想要永久性改变，则需要更改网卡配置，此处的DNS服务器写为本机，让身兼服务器、客户端二职。

![截屏2021-11-24 上午12.55.40](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午12.55.40.png)



使用命令==`host www.gudako.chaldea`==，可以看到解析出来的IP地址是192.168.66.166。

使用命令==`host master.gudako.chaldea`==，可以看到除了解析出正确的IP地址，还指出该域名是别名并显示原域名，可以看出，正向解析设置成功。

![截屏2021-11-24 上午1.05.19](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.05.19.png)



### 3.2.2、域名解析命令

除了==`host`==命令可以用于查询域名信息，还有==`nslookup`==命令也可以做到查询域名信息，两张能做同样的事情，不过还是有差别的：

==`host`==命令是非交互性命令，只能获取特定的名称或所需信息。

==`nslookup`==命令可作为交互性命令，也可以作为非交互性命令：

使用命令==`nslookup 域名/IP地址`==会进入非交互模式，只能获取特定的名称或所需信息。

直接使用命令==`nslookup`==会进入交互模式，用户可以向域名服务器查询各类主机、域名的信息，或者输出域名中的主机列表，要退出则需要手动输入==`exit`==。

如下图，使用命令==`nslookup www.gudako.chaldea `==能获取服务器的服务器名称以及IP地址，直接使用命令==`nslookup`==进入交互模式，在尖括号后输入域名或IP可以获得对应的信息，输入==`exit`==退出。

![截屏2021-11-24 上午1.07.06](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.07.06.png)

==`dig`==命令用于显示详细的解析流程。

使用方法：==`dig 域名/IP地址 `==，如下图，使用==`dig www.dudako.chaldea`==能看到解析的详细流程，显示的信息符合配置文件里的信息。

![截屏2021-11-24 上午1.07.33](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.07.33.png)

### 3.2.3、域名反向解析

既然有正向解析，那么有反向解析吗？答案是：有的！

反向解析的写法比较特别，需要“倒着”写==网段==。

使用命令==`vim /var/named/chroot/etc/named.conf`==进入DNS主配置文件，在主配置文件里面可以看到inclue配置写了两条，其中一条命令里的提到的etc目录下==rfc1912.zones==这个模版文件内包含反向解析的格式，如果忘记了书写格式可以进去看一下。

![截屏2021-11-24 上午1.09.05](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.09.05.png)

使用==`vim /etc/named.rfc1912.zones`==查看该模版文件，框中的那个地方就是反向解析域配置的写法。

![截屏2021-11-24 上午1.11.12](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.11.12.png)

```shell
#假设你的IP为AAA.BBB.CCC.DDD，则你的书写为如下
zone "CCC.BBB.AAA.in-addr.arpa" IN {
        type master;
        file "AAA.BBB.CCC.arpa";
};
```

使用命令==`vim /var/named/chroot/etc/named.conf`==回到DNS主配置文件，在正向解析域后面接着写上反向域配置。

![截屏2021-11-24 上午2.27.48](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午2.27.48.png)



使用命令==`cd /var/named/chroot/var/named`==进入到DNS配置目录下，然后使用==`cp -p named.loopback 192.168.66.arpa`==命令给反向配置模版文件改名，使用命令==`vim 192.168.66.arpa`==编辑。

![截屏2021-11-24 上午1.16.08](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午1.16.08.png)

反向解析文件和正向解析文件在写法上没什么差别，格式如下：

```java
[zone] IN SOA [主机名][管理员email]#设置SOA
[zone] IN NS [名称]
/*
PTR全称Pointer Record，又称指针记录，是一个将IP地址解析为域名或主机名的记录
此处反写IP，可以简写，可以详细写
比如你的IP是AAA.BBB.CCC.DDD，对应的域名为mail.163.com,则可以写成以下两种形式：
详写：DDD.CCC.BBB.AAA PTR mail.163.com
略写：DDD PTR mail.163.com
*/
[反写的IP] PTR [域名]
```

下图的配置转换成文字表述为：

将ns1.gudako.chaldea.设置为66.168.192.in-addr.arpa.域的权威服务器。

将192.168.66.166反向映射到域名www.gudako.chaldea。

![截屏2021-11-24 上午2.28.12](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午2.28.12.png)

使用命令==`named-checkconf ../../etc/named.conf`==检查主配置配置是否有错误，没有错误返回空白，有错误则回返回报错信息，需要检查配置。

使用命令==`named-checkzone gudako.chaldea /var/named/chroot/var/named/gudako.chaldea.org`==检查区域配置文件的配置是否有错误，没有错误返回空白，有错误则回返回报错信息，需要检查配置。

![截屏2021-11-24 上午2.28.53](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午2.28.53.png)

使用命令==`systemctl restart named-chroot.service`==重启DNS服务，然后使用==`host/nslookup 192.168.66.166`==来检验反向解析是否成功，可以看到域名解析成功，证明反向解析。

![截屏2021-11-24 上午2.30.11](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 上午2.30.11.png)



## 3.3、DNS容灾/冗余配置

==冗余不是一个完全的贬义词==，不要觉得重复、多余的东西一定是没有用的。



在实际工作环境中，服务器开启之后，总会发生一些可预见或者是不可预见的天灾人祸，比如运维的“不小心”、服务器突然断电、黑客的攻击等等，如果这时候有额外的、能够投入使用的、有相同配置的备用服务器，那就能大大减少损失了，由此可见，冗余技术是能够提高稳定性的。



在现实工作环境中，需要==多台==服务器来实现容灾技术（==至少两台==）。



此处准备两台CentOS 7的虚拟机来实现DNS容灾，主服务器192.168.66.2，备用服务器192.168.66.3。

==⚠️注意，在准备该实验前，请关闭防火墙！！！！请关闭防火墙！！！！请关闭防火墙！！！！==

### 3.3.1、备用服务器的DNS初步配置

使用==`yum -y install bind bind-chroot`==命令给备用服务器安装DNS服务。

==⚠️注意，若使用yum安装，要先安装DNS服务后再修改网卡配置，不然没法使用yum安装==。

![截屏2021-11-24 下午7.32.03](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午7.32.03.png)

使用命令==`scp root@192.168.66.2:/var/named/chroot/etc/named.conf /var/named/chroot/etc/`==将主服务器的DNS主配置文件拷贝到备用服务器中。

![截屏2021-11-24 下午7.50.45](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午7.50.45.png)

使用命令==`cd /var/named/chroot/etc/`==查看主配置文件夹，可以看到==named.conf==的从属组与其他文件不一致，很可能会造成后续的出错，所以要使用==`chgrp named named.conf`==命令给==named.conf==更改所属组。

![截屏2021-11-24 下午8.14.00](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.14.00.png)

### 3.3.2、备用服务器的DNS主配置文件

使用命令==`vim /var/named/chroot/etc/named.conf`==。

将==options==配置中的监听IP换成==本机IP==。

![截屏2021-11-24 下午8.02.41](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.02.41.png)

修改==zone==配置，区域文件不变，将type改成==slave==（从属），并追加参数==master{ 主服务器的IP地址; }== 。

![截屏2021-11-24 下午8.02.50](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.02.50.png)

使用命令==`systemctl restart named-chroot.service`==对主服务器的DNS服务进行重启。

然后使用==`vim etc/resolv.conf`==修改本机DNS。

![截屏2021-11-24 下午7.30.36](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午7.30.36.png)

### 3.3.3、检验备用服务器的解析功能

在备用服务器使用==nslookup www.gudako.chaldea==命令验证反向解析，可以看到能够正确显示解析服务器的IP地址和域名对应的IP地址。



![截屏2021-11-24 下午8.15.44](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.15.44.png)

使用==`nslookup 192.168.66.166`==命令验证反响解析，可以看到能够返回IP地址对应的域名。

![截屏2021-11-24 下午8.16.03](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.16.03.png)

以上两条命令的测试证明该备用服务器的解析与主服务器一致，冗余配置成功。

### 3.3.4、检验备用服务器的同步功能

为了验证备用服务器的同步功能，此处会对主服务器的DNS文件进行修改，然后查看备用服务器是否同步。

回到主服务器中，使用==`vim /var/named/chroot/var/named/gudako.chaldea.org`==打开区域配置文件，在文件底部追加新的映射记录，以下为追加的内容：

```shell
#格式：[主机名] A [IP地址]
humanevil A 192.168.66.233
```

![截屏2021-11-24 下午8.30.17](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.30.17.png)

追加完成后，在主服务器上输入命令==`rndc reload`==重启服务器，然后使用==`nslookup humanevil.gudako.chaldea`==命令测试，可以看到，域名解析成功。

![截屏2021-11-24 下午8.37.53](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.37.53.png)

回到备用机上，在DNS配置目录==/var/named/chroot/var/named==下，使用==`ls`==命令查看配置文件，看清楚后文件名再进行接下来的同步操作。

==⚠️注意，小心使用rm -rf！另外，要删除掉原文件后才能进行同步操作==

使用==`rm -rf *.org`==删除正向解析区域文件，使用==`rm -rf *.arpa`==删除反向解析区域文件。

然后使用==`systemctl restart named-chroot.service`==对备用服务器的DNS服务进行重启。

最后使用==`nslookup humanevil.gudako.chaldea`==命令验证是否能解析新写入的主机，可以看到，能够解析，证明同步功能配置成功。

![截屏2021-11-24 下午8.38.16](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-24 下午8.38.16.png)



## 3.4、DNS智能解析

传统的DNS解析，不判断访问者来源，会随机选择其中一个 IP 地址返回给访问者。

我国是面积很大的国家，解析服务器分布在很多个城市，但如果DNS不够“智能”，不跟根据区域来源返回IP地址，那解析速度会大打折扣。

而智能DNS解析会对访问者的来源进行判断，选择一个最优的IP返回，能够减少解析时间，优化使用体验。

此处实验的智能解析写得比较简单，就显得不够“智能”，此处的智能解析的效果如下：

```java
/*
假设情形如下：
来访者192.168.66.20解析www域名，会返回2.2.2.2
来访者192.168.66.30解析www域名，会返回3.3.3.3
本机192.168.66.2解析www域名，会返回192.168.66.166
*/
```

### 3.4.1、修改DNS主配置文件

使用命令==`vim /var/named/chroot/etc/named.conf`==进入DNS主配置文件中。

在==option配置==后面加入数条==ACL规则==，这几条ACL规则用于后续的view配置

```shell
#ACL写法远不止图中那种，写入IP地址知识其中一种写法
acl{
	[IP地址/网段];
}
```

![截屏2021-11-25 下午2.13.23](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.13.23.png)

删除掉原来的两个==zone==配置，然后在==ACL规则后面==写数条==view==配置。

==⚠️注意，view配置内可以写入zone配置，只要写了一个view配置，zone配置不能写在view配置外，除非你新建一个配置文件来进行利用==。

```java
/*
view配置的格式如下
view后面的xxx为该view配置的名字
match-clients{ xxx; }该配置是根据ACL规则内的IP来匹配主机的，所以在这个文件写入的ACL规则要写入IP地址
剩下的zone文件配置与前面写的一样，可以参考前面的内容来进行修改
*/
view xxx{
	match-clients{ xxxxx; };
zone "xxx" IN{
		type master;
		file "xxx";
};
};
```

修改好的view配置如下，此处为了做智能解析，区域配置文件会进行一定的更改。

![截屏2021-11-25 下午2.13.40](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.13.40.png)

![截屏2021-11-25 下午2.13.55](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.13.55.png)

### 3.4.2、修改DNS区域文件

使用命令==`cd /var/named/chroot/var/named`==进入DNS区域配置文件目录

然后使用==`cp gudako.chaldea.org gudako.chaldea.org.gz`==、==`cp gudako.chaldea.org gudako.chaldea.org.gz`==来复制一份能用于智能解析的DNS区域配置文件

![截屏2021-11-25 上午1.43.44](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 上午1.43.44.png)



使用==`vim`==命令进入DNS区域配置文件，然后将==www==那一行的内容进行修改，只需修改IP地址，修改后的区域配置文件如下：

![截屏2021-11-25 下午2.17.11](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.17.11.png)

![截屏2021-11-25 下午2.17.23](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.17.23.png)



### 3.4.3、智能解析验证

开另一台CentOS 7虚拟机来配合验证，将==IP修改成静态==，将==DNS设为192.168.66.2==，然后==重启网络==，==最后主机和测试机都要关闭防火墙！！！==

然后使用==`nslookup www.gudako.chaldea`==查看域名解析效果。

以下是改成192.168.66.20的解析效果，解析出的IP为2.2.2.2，符合DNS主配置文件的配置。

![截屏2021-11-25 下午2.21.48](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.21.48.png)

以下是改成192.168.66.20的解析效果，解析出的IP为3.3.3.3，符合DNS主配置文件的配置。

![截屏2021-11-25 下午2.22.40](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.22.40.png)

以下是本机192.168.66.2解析本机的效果，解析出的IP为本机，符合DNS主配置文件的配置。

![截屏2021-11-25 下午2.24.55](/Users/lamchingkeung/Desktop/dns_server_screenshot/截屏2021-11-25 下午2.24.55.png)

可以看到”简单的智能解析”配置成功，不过想要达到真正的智能解析还要很长的一段路。



# 4、Zabbix的搭建与应用

## 4.1、Zabbix服务端的搭建

### 4.1.1、一些监控命令的简单了解

1、==`free`==命令，用于查看内存使用情况。

![image-20211127152702534](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127152702534.png)

2、==`df`==命令，用于查看磁盘使用情况。

![截屏2021-11-27 下午3.27.26](/Users/lamchingkeung/Library/Application Support/typora-user-images/截屏2021-11-27 下午3.27.26.png)

3、==`uptime`==命令，用于查看Linux系统负载信息，显示的信息显示依次为：现在时间、系统运行时常、登录用数量，以及系统在过去的1分钟、5分钟和15分钟内的平均负载。

![image-20211127152848838](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127152848838.png)

4、==`top`==命令，能查看系统整体运行情况。相比于uptime命令，top命令能够提供更多的系统数据，还能提供一个交互界面，==实时返回信息==，而==`uptime`只打印静态==的系统数据。

![image-20211127153539546](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127153539546.png)

5、==`wmstat`==命令，能返回系统整体数据的命令。

~~==`vmstat`==命令 的含义为显示虚拟内存状态（Viryual Memor Statics），但是它可以报告关于进程、内存、I/O等系统整体运行状态。~~

![image-20211127154124040](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127154124040.png)

以上介绍的命令是==部分系统自带的命令==，还有一些是需要通过额外安装才能使用的命令：

比如==`htop`==、==`iftop`==、==`iotop`==等命令可以通过==`yum`==命令进行安装后使用，在使用yum安装前，如果不确定安装包名称，可以使用==`yum provides [软件包名]`==来查询安装包名称。



### 4.1.2、Zabbix服务端的安装与配置

==⚠️注意，在实际工作环境中，如果服务器数量较少，运维人员能管得过来，可以编写数个Shell脚本来对系统进行监控即可，没必要安装Zabbix==



当然此处是实验，不是实际工作环境。



#### 4.1.2.1、查看官方文档

==Zabbix官网提供了安装方法==，网址为https://www.zabbix.com/download。

进入网站后选择自己的需求和服务器条件，就会有对应的教程。

比如下图，我们选择Zabbix版本为5.0 LTS、系统选择CentOS，系统版本选择7，数据库选择MySQL，WEB服务软件选择Apache，下面就会有对应的教程。

==LTS是Long Term Support的缩写，指的是长期支持版本==。

![image-20211127202115644](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127202115644.png)

![image-20211127202414043](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127202414043.png)

![image-20211127202426704](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127202426704.png)

当然，==考虑到网络状况，官方的安装方法不能完全照搬==，需要进行==“一点点改变”==。



#### 4.1.2.2、关闭防火墙和SELinux

```shell
# 临时关闭防火墙
systemctl stop firewalld.service
# 永久关闭防火墙
systemctl disable --now firewalld.service
# 永久关闭 SELinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
# 临时关闭 SELinux
setenforce 0
```

此处我们永久关闭防火墙和SELinux

![截屏2021-11-26 上午9.49.12](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午9.49.12.png)

<img src="/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午9.49.26.png" alt="截屏2021-11-26 上午9.49.26" style="zoom: 150%;" />

#### 4.1.2.3、“LAMP”的安装

==LAMP不是一个软件，是一些软件缩写的“集合”==。

LAMP是一个经典WEB软件包的集合，这个软件组合能==用于动态网站或服务器的搭建==。

==LAMP最初是四个软件的缩写==，分别是Linux、APache、Mysql、PHP，==不过随着各种软件的迭代升级，出现了各种很多代替方案==，比如：LAMJ（JavaScript代替PHP）、XAMP（XML代替Linux）、WAMP（Windwos Server代替Linux）等方案。

LAMP里的各个字母缩写里也有了代替，比如：

M：MySQL/MariaDB（MariaDB是MySQL的社区版）

P：PHP/Perl/Python



此处实验我们安装==微改版的LAMP==，即Linux、Apache、MariDB、PHP。

由于我们已经是在Linux上，所以==只需要安装Apache、MariDB、PHP==。



==⚠️注意，本节需要使用多次yum命令进行软件包安装，请提前更换合适的镜像源==



##### 4.1.2.3.1、安装Apache

使用命令==`yum -y install httpd`==安装Apache。

使用命令==`systemctl enable httpd.service`==设置Apache开机自启。

使用命令==`systemctl start httpd.service`==开启Apache服务。

最后两条==`systemctl`==命令输入没报错证明Apache安装成功。

![截屏2021-11-26 上午9.55.25](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午9.55.25.png)



##### 4.1.2.3.2、安装MariaDB

此处之所以选择MariaDB，是==因为安装比MySQL方便==所以才选择了它。

使用命令==`yum -y install mariadb mariadb-server`==安装MariaDB包和MariaDB-server包。

使用命令==`systemctl start httpd.service`==启动MariaDB服务。

![截屏2021-11-26 上午9.57.32](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午9.57.32.png)

==因为MariaDB是MySQL的社区版，所以可以直接使用MySQL的命令==

使用命令==`mysql`==启动数据库，开启成功后，使用==`exit`==退出，证明MariaDB安装成功。

![截屏2021-11-26 上午9.57.54](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午9.57.54.png)

##### 4.1.2.3.2、安装PHP

使用命令==`yum -y install php php-mysql`==安装php包、php-mysql包。

![截屏2021-11-26 上午9.58.45](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午9.58.45.png)

#### 4.1.2.4、Zabbix的安装

##### 4.1.2.4.1、安装Zabbix库

官方给出的rpm安装命令如下：

```shell
#使用Zabbix官方的rpm命令升级Zabbix库
rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm
#清除所有使用yum指令下载的软件包和header文件
yum clean all
```

<img src="/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127200401265.png" alt="image-20211127200401265" style="zoom:150%;" />

==当然，官方的命令比较适合网络非常好的环境下运行==。

如果网络不太好，可以==把zabbix的rpm源改成国内开源镜像站的rpm源，下载速度会有大大改善==。

==⚠️注意，在使用国内开源镜像站安装Zabbix库之前，需要先去镜像站查看是否有Zabbix的文件，中科大开源镜像站就没有Zabbix！==

例如：将官方rpm源换成清华大学开源镜像站的rpm源

```java
/*
Zabbix官方rpm源：
https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm
修改成清华大学开源镜像站rpm源：
https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm
*/
```

所以可以将安装命令改成：

```shell
#使用修改成国内开源镜像站的rpm命令升级Zabbix库
rpm -Uvh https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm
#清除所有使用yum指令下载的软件包和header文件
yum clean all
```

![截屏2021-11-26 上午10.00.08](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.00.08.png)

![截屏2021-11-26 上午10.00.56](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.00.56.png)

安装Zabbix库后，使用==`vim /etc/yum.repos.d/zabbix.repo`==命令编辑Zabbix的库文件：

将里面的[zabbix]、[zabbix-frontend]配置的==baseurl参数的Zabbix官方链接修改成国内镜像园的链接==。

即，将==/$basearch/==前的路径切换成清华镜像园的路径，具体如下：

```java
/*
https://repo.zabbix.com/zabbix/5.0/rhel/7
修改成
https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7
*/
```

最后再将==[zabbix-frontend]参数==中的==enable=0改成enable=1==，具体效果如下：

![截屏2021-11-26 上午10.12.05](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.12.05.png)



##### 4.1.2.4.2、安装Zabbix核心包

使用命令==`yum -y install zabbix-server-mysql zabbix-agentq`==安装Zabbix服务端包和Zabbix客户端包。

![截屏2021-11-26 上午10.13.56](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.13.56.png)

使用命令==`yum -y install centos-release-scl`==安装Zabbix前端包。

![截屏2021-11-26 上午10.14.48](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.14.48.png)

使用命令==`yum -y install zabbix-web-mysql-scl zabbix-apache-conf-scl`==安装 Zabbix 前端软件和相关环境包。

![截屏2021-11-26 上午10.18.04](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.18.04.png)

#### 4.1.2.5、Zabbix数据库的建立与设置

##### 4.1.2.5.1、数据库的安全设置

这个步骤是给数据库做一个简单的、安全的优化。

输入命令==`mysql_secure_installation`==，进入到数据库安全设置。

```java
//此处让我们输入最新的root密码。
//刚安装是没有root密码的，直接输入回车即可。
Enter current password for root (enter for none):

//是否设置root密码？此处填否。
Set root password? [Y/n] n

//是否移除匿名用户，此处填是
Remove anonymous users? [Y/n] y

//允许root远程登录，此处填是
Disallow root login remotely? [Y/n] n

//是否移除test数据库，此处填是
Remove test database and access to it? [Y/n] y

 //是否重载权限表，此处填是
Reload privilege tables now? [Y/n] y 
```

![截屏2021-11-26 上午10.24.50](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.24.50.png)

<img src="/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.25.54.png" alt="截屏2021-11-26 上午10.25.54" style="zoom:150%;" />

##### 4.1.2.5.2、Zabbix数据库的建立

使用==`mysql`==命令进入MariaDB，使用命令==`select current_user();`==查看当前用户

![截屏2021-11-26 上午10.28.12](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.28.12.png)

使用命令==`create database zabbix character set utf8 collate utf8_bin;`==创建一个字腹集为uff-8、名字为zabbix的数据库。

使用命令==`create user zabbix@localhost identified by 'yajyu114514';`==创建zabbix用户并赋予一个自定义的密码。

使用命令==`flush privileges;`==刷新权限表。

使用命令==`grant all privileges on zabbix.* to zabbix@localhost;`==赋予zabbix用户赋予所有权限。

使用命令==`SHOW DATABASES;`==查看数据库，可以看到zabbix。

![截屏2021-11-26 上午10.31.12](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.31.12.png)

使用==`USE zabbix;`==命令切换到zabbix数据库，可以证明zabbix数据库成功创建。

![截屏2021-11-26 上午10.33.17](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.33.17.png)

##### 4.1.2.5.3、Zabbix数据库的数据导入

使用命令==`rpm -ql zabbix-server-mysql | grep sql`==查看Zabbix-server-mysql包的安装目录，可以看到和sql创建指令相关的文件在==/usr/share/doc/zabbix-server*/==下。

![截屏2021-11-26 上午10.33.59](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.33.59.png)

使用命令==`zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz |
mysql -uzabbix -pyajyu114514 zabbix`==解压并导入初始架构和数据到zabbix数据库。

```java
/*
-u后跟用户名，-p后跟自己输入的密码。
zcat，不看内容解压，通过管道符传输到 zabbix 数据库。
*/
```

![截屏2021-11-26 上午10.35.16](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.35.16.png)

使用命令==`mysql zabbix -e 'show tables'`==查看所有的表，如果能看到很多数据，可以证明Zabbix的初始框架和数据成功导入到zabbix数据库了。

![截屏2021-11-26 上午10.36.16](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.36.16.png)

#### 4.1.2.6、Zabbix配置文件修改

##### 4.1.2.6.1、Zabbix数据库配置文件修改

使用命令==` /etc/zabbix/zabbix_server.conf`==进入Zabbix数据库配置文件。

跳到第124行，在==DBPassword=======后追加zabbix用户密码yajyu114514。

![截屏2021-11-26 上午10.37.48](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.37.48.png)

##### 4.1.2.6.1、Zabbix前端PHP配置文件修改

使用命令==/etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf==进入Zabbix前端PHP配置文件。

将==php_value[date.timezone]=======后的值修改成==Asia/Shanghai==。

![截屏2021-11-26 上午10.52.00](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.52.00.png)

### 4.1.3、启用和Zabbix相关的服务

使用命令==`systemctl restart zabbix-server.service zabbix-agent.service  httpd.service  rh-php72-php-fpm.service `==重启和Zabbix有关的服务
使用命令==`systemctl enable zabbix-server.service  zabbix-agent.service  httpd.service  rh-php72-php-fpm.service `==把和Zabbix有关的服务设置为开机自启

![截屏2021-11-26 上午10.40.38](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.40.38.png)

重启，然后使用命令==`netstat -lntup | grep 10051`==查看10051的状况，可以看到Zabbix服务开启成功。

![截屏2021-11-26 上午10.44.11](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.44.11.png)

以上，就是Zabbix服务端的安装与配置了。

### 4.1.4、Zabbix网页端安装

打开浏览器，URL栏输入==IP地址/zabbix==进入到Zabbix网页端，==这个网页端可以使用物理机打开==

==如果实在物理机或者是其他虚拟机上，需要输入具体的服务端IP地址。==

==如果是服务端本地打开，则可以直接输入localhost。==

看到下面那个界面，则证明zabbix网页端还没安装，被引导到了一个安装脚本中，点击下一步继续。

![截屏2021-11-26 上午10.45.24](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.45.24.png)

这个界面是检查网站所需要的配置是否符合要求，如果全部OK，点击下一步。

![截屏2021-11-26 上午10.45.54](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.45.54.png)

这个见面是数据库连接配置，数据库类型，主机地址、端口、数据库名字、数据库用户直接使用默认的，密码输入之前设定好的用户密码。

![截屏2021-11-26 上午10.46.14](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.46.14.png)

这个界面是设置服务器的具体信息，主机IP地址和端口默认不改，服务器名称自定义。

![截屏2021-11-26 上午10.46.35](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.46.35.png)

到这一步检查一下自己设置的信息，如果有误，就返回设置，如果没有错就下一步。

![截屏2021-11-26 上午10.46.42](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.46.42.png)

到了这个界面，证明安装成功，点击Finish退出安装。

![截屏2021-11-26 上午10.46.53](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.46.53.png)

在浏览器里重新进入==IP地址/zabbix==，可以看到登录界面

==用户名默认Admin，密码默认zabbix==

![截屏2021-11-26 上午10.47.03](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.47.03.png)

登录成功后界面如下。

![截屏2021-11-26 上午10.52.49](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.52.49.png)



点击左边设置栏的==User settings==，然后在Language栏选择中文，然后点击==Upadte==更新设置。

![截屏2021-11-26 上午10.53.08](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午10.53.08.png)

更新界面语言后，除了部分专有名词、部分不知道该怎么翻译的词语，很多地方都成功汉化了。

==当然，有一部分翻译就和机翻一样根本没法看，如果对自己的英语水平有信心，可以切换成英语进行解下来的操作，==~~==能够避免被渣翻气晕==~~。

### 4.1.5、修改Zabbix的PHP配置文件（选看）

使用==`vim /etc/zabbix/web/zabbix.conf.php`==命令进入Zabbix有关PHP配置的配置文件。

![image-20211127234242843](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211127234242843.png)

==1、后期迁移数据库文件的时候，需要修改上述的文件。==

==2、如果你忘记Zabbix数据库的账号和密码，可以来该文件查看。==

## 4.2、Zabbix监控客户端

### 4.2.1、客户端安装Zabbix

准备另一台Linux虚拟机，将yum源换成国内开源镜像站。

首先要安装==Zabbix库==：

```shell
#请根据自身的网络环境来选择安装该命令，如果对自己网络有信心，可以使用Zabbix官方的命令，如果条件不好，可以将命令中的链接修改成国内开源镜像站的链接。

#直接使用Zabbix官方提供的命令安装Zabbix库：
rpm -Uvh
https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-
1.el7.noarch.rpm

#将Zabbix官方命令中的链接清华大学开源镜像站后，安装Zabbix库：
rpm -Uvh https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm
```

![截屏2021-11-26 上午11.08.39](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.08.39.png)

最后u使用命令==`yum clean all`==手动清除所有的rpm包和header文件。

![截屏2021-11-26 上午11.08.58](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.08.58.png)

然后使用命令==`yum -y install zabbix-agent`==安装Zabbix客户端包。

![截屏2021-11-26 上午11.10.53](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.10.53.png)

### 4.2.2、客户端修改zabbix-gent文件

使用命令==` vim /etc/zabbix/zabbix_agentd.conf/^Server`==进入Zabbix客户端的配置文件。

找到==Server=======处，追加或修改服务端的IP地址。

![截屏2021-11-26 上午11.27.22](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.27.22.png)

### 4.2.3、启用Zabbix客户端

选择以下两条命令==关闭防火墙和SELinux==

```shell
# 临时关闭防火墙
systemctl stop firewalld.service
# 永久关闭防火墙
systemctl disable --now firewalld.service
# 永久关闭 SELinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
# 临时关闭 SELinux
setenforce 0
```

使用命令==`systemctl restart zabbix-agent.service`==重启Zabbix客户端服务

使用命令==`systemctl enable zabbix-agent.service`==允许Zabbix客户端服务开机自启

![截屏2021-11-26 上午11.24.23](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.24.23.png)

### 4.2.4、Zabbix网页端添加客户端主机

进入到Zabbix网页端，点击配置——>主机——>创建主机

![截屏2021-11-26 上午11.15.39](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.15.39.png)

==主机名称要求名称唯一==，所以昵称==可以是IP地址==，也可以是==一目了然的名称==，此处起名test_client_centos7。

![截屏2021-11-26 上午11.17.30](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.17.30.png)

主机有多台，要求分组，==群组可以按业务分类，也可以按功能分类==，所以此处起名test_group。

IP地址根据客户端机子自身来填，端口默认不改。

==配置完主机参数后，不要着急点添加，点击模版，继续配置，提前点击添加会导致无法监控客户端。==

![截屏2021-11-26 上午11.17.30](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.17.30.png)

点击添加模版，选择==Templates/Operating systems==，再选择==Templates OS Linux by Zabbix agent==，点击==蓝色的选择==确认选择。

![截屏2021-11-26 上午11.18.21](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.18.21.png)

==确认无误后再点击添加==。

![截屏2021-11-26 上午11.18.30](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.18.30.png)

添加完成后，回到配置主机总页面是可以看到添加的主机。

等待数分钟或者是到服务端输入命令==`systemctl restart zabbix-server.service`==重启Zabbix服务端的服务，==ZBX可用性变为绿则证明添加监控主机成功==。

==若在添加主机的时候没有配置模版，就会导致ZBX可用性变灰！==

![截屏2021-11-26 上午11.29.18](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.29.18.png)

## 4.3、Zabbix监控项配置

### 4.3.1、Zabbix监控模版查看

我们可以在主机界面中看到客户端有42个监控项、11个应用集，点击监控项会进入到另一个界面，可以看到具体的应用集。

![截屏2021-11-26 上午11.29.57](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.29.57.png)

点击左边功能栏的监测——>最新数据中，可以看到最新的主机数据，如图所示，我们可以看到客户端CPU的最新数据

![截屏2021-11-26 上午11.30.30](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.30.30.png)

在应用集这个输入框中，点击选择，此处我们点击security

![截屏2021-11-26 上午11.33.03](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.33.03.png)

可以看到过滤到只剩下一项，点击名称进入到详细配置。

![截屏2021-11-26 上午11.33.22](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.33.22.png)

此处我们可以看到监控项的各项参数，我们可以修改多项参数，==灰色框代表该参数无法修改==，我们可以修改更新间隔，让这个监控更新变频繁或者几乎不更新。

![截屏2021-11-26 上午11.33.58](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.33.58.png)

==当我们修改了文件内容，文件md5值就会发生改变==。

这个监控项监控的是/etc目录下的passwd文件，而passwd文件中，==增加了用户或者是修改了密码，passwd文件的md5值就会发生改变==，所以==passwd文件会被纳入到安全监控==中。

### 4.3.2、自定义监控项

==Zabbix自带的监控项是远远不够的，还需要自己手动写入一些监控项==。

#### 4.3.2.1、命令行测试获取监控命令数据

回到在客户端主机。

输入命令==`iostat | awk '/sda/'`==可以看到磁盘设备的使用状态，从左到右分别是设备名、设备转速、每秒读取速度、每秒写入速度、读取总量、写入总量。

输入命令==`iostat | awk '/sda/{print $2}'`==，可以仅显示磁盘的转速。

![截屏2021-11-26 上午11.35.09](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.35.09.png)

#### 4.3.2.2、服务端修改zabbix-agent配置文件

使用命令==`vim /etc/zabbix/zabbix_agentd.conf`==进入Zabbix客户端配置文件

找到关键词有==UserParameter=======的那一行，可以看到自定义监控项的模版。

格式为==`UserParameter==<key><shell command>`==。

![截屏2021-11-26 上午11.38.15](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.38.15.png)

在监控项的具体配置中，我们可以看到Zabbix自带的Key值为vfs.file.cksum[/etc/passwd].

![image-20211128020039711](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211128020039711.png)

不过==key值==是可以自定义的，所以==key值起名需要一目了然，到了后面还要用这个key值==。

在注释模版后一行我们写入==`UserParameter==sda_tps,iostat | awk '/sda/{print $2}'`==。

![截屏2021-11-26 上午11.49.16](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.49.16.png)

#### 4.3.2.3、服务端测试Zabbix监控项取值

此处我们使用命令==`yum -y install zabbix-get.x86_64 &>/dev/null`==

这条命令的意思是==使用yum安装的Zabbix-get.x86_64包的信息重定向到/dev/null==，而==/dev/null是一个“无底洞设备”==，通俗来讲就是==将yum安装信息扔到了无底洞里，使得这些安装信息不显示出来==。

然后使用==`echo $?`==能够返回上一条命令是否成功执行，成功执行返回0，不成功返回非零数。

![截屏2021-11-26 上午11.41.33](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.41.33.png)

```
zabbix_get -s AAA.BBB.CCC.DDD -k Key 
-s后跟着IP地址
-k后跟着Key值
```

使用命令==`zabbix_get -s 127.0.0.1 -k vfs.file.cksum[/etc/passwd]`==可以看到passwd文件的md5值，这条命令的key值是在Zabbix安装时就已经设定好的

使用命令==`zabbix_get -s 127.0.0.1 -k sda_tps`==可以看到磁盘的转速，这条命令的Key值是自己设定的。

从第二条命令可以得知，自定义监控配置成功。

![截屏2021-11-26 上午11.49.45](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.49.45.png)

#### 4.3.2.4、Zabbix网页端添加自定义监控项

进入Zabbix网页端，点击配置——>主机，点击Zabbix_server的监控项。

![截屏2021-11-26 上午11.52.33](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.52.33.png)

然后点击==创建监控项==。

![截屏2021-11-26 上午11.51.29](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.51.29.png)

进去后，

==起一个一目了然的名称==。

==键值填入前面设定好的Key值==。

==磁盘转速是有小数点的，信息类型选浮点数==。

==更新间隔不用太频繁，别让数据库超负荷工作==。

==确认无误后点击添加==。

![截屏2021-11-26 上午11.56.01](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.56.01.png)

应用集里点击Disk sda可以看到我们新添加的监控项

![截屏2021-11-26 上午11.56.54](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.56.54.png)

点击左侧功能栏，==点击监测——>最新数据==，收起CPU栏，可以看到我们设置的sda转速监控项的最新数据。

![截屏2021-11-26 上午11.57.39](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.57.39.png)

## 4.4、Zabbix触发器配置

==光有监控而没警报，是不够的==。

~~如果某项监控数值异常，刚好你没看到，也没有警报，服务器怎么嗝屁的你也不知道。~~

所以除了监控项，还需要触发器。这个触发器会在数值达到某个值时，发出警报。

### 4.4.1、开启警报推送

在网页端Zabbix主界面中，点击User Settings，然后点击正在发送消息。

**先说几丑句**。

==Zabbix有些中文翻译是真的烂！（注意，这里用词是有些，不是全部，这里不是要完全否定Zabbix的中文翻译）==

界面中的正在发送消息、前段消息中看了半分钟，愣是没看懂，我去查了一下官方文档，==原来messaging被翻译成正在发送消息/消息中，难怪我看不懂！==

==下面是我认为是正确的翻译（本人翻译渣，仅供参考，但能够确定官方翻译出错了）==

==Messaging、Frontend messaging这两个翻译应该分别翻译成信息推送、网页端全局推送信息。==

![](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211128024402255.png)



好了，一些话说完了，在这个界面中，==勾选所谓的“前端信息中”==，然后==勾选所有触发器的警示度==，然后点击更新。

![截屏2021-11-26 上午11.58.08](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.58.08.png)

![截屏2021-11-26 上午11.58.22](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 上午11.58.22.png)

### 4.4.2、测试自带触发器

点击左边栏的配置——>主机，然后我们可以看到，监控项数量与触发器的数量不对等，可见不是每一个监控项都需要触发警报的。

![image-20211128030005936](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211128030005936.png)





其中一台主机的点进触发器，可以看到一些主机的触发项。

本次试验拿客户端机来测试触发器。

我们随便查看其中一项，这一条是有关重启的触发器，这个触发器的触发条件是系统运行时间少于10分钟，由于重启后运行时间清零，所以这个触发器是用于监测客户端是否重启了。

![截屏2021-11-26 下午11.44.09](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.44.09.png)

这一条命令是查看系统负载均衡的，如果高于了某个值，就会发生发生警报。

![截屏2021-11-26 下午11.37.22](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.37.22.png)



关闭客户端，将虚拟机配置改低，然后重新开启客户端。

![截屏2021-11-26 下午6.27.09](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午6.27.09.png)

可以看到一开机，客户度那边就多了两条警报，一条是负载均衡过高警报，一条是客户端重启警报，而且能==听到巨响的警报声==！

![截屏2021-11-26 下午6.26.45](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午6.26.45.png)

将客户端关闭，配置更改回原先良好的配置，然后重新启动客户端，还是多了一条重启警报，不过没有了系统负载均衡过高的警报，再过了数分钟，警告就没了，然后记录到了数据库中。

### 4.4.3、自定义触发器

触发器和监控项一样，仅仅用自带的还是不太够，所以需要自定义一些符合实际需求的触发器。

此处自定义的触发器==以用户登录数量等于某值为条件==的触发器。

点击主机的触发器选项，然后点击==创建触发器==。

![截屏2021-11-26 下午11.49.44](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.49.44.png)

==触发器名称要一目了然==。

点击==表达式框旁的添加==按钮，进入条件配置。

点击监控项框旁的选择。

![截屏2021-11-26 下午11.52.52](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.52.52.png)

然后选择==Number of logged in users==，然后点击选择

![截屏2021-11-26 下午11.52.31](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.52.31.png)

然后表达式中的数值可以自定义，严重性也可以自定义。

此处我们填写的表达式数值为3，严重性选严重，即==登录用户大于3，发出严重警报==。

![截屏2021-11-26 下午11.54.21](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.54.21.png)

选中==“事件成功迭代”==的==恢复表达式==，然后将==>=3修改成<3==。

~~说实在的，时间成功迭代的原文叫“OK events generation”，我也不知道该怎么翻译，官方给的翻译我也看不懂，这个看得我有点模棱两可，不过还在还能看懂有恢复表达式。~~

![截屏2021-11-27 上午12.00.06](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午12.00.06.png)

### 4.4.4、测试自定义触发器

此处开启macOS自带的终端，开启多个终端窗口，==使用ssh远程登录来模拟用户登录==。

==（Windows用户可以在CMD运行ssh命令登录，也可以使用SecureCRT、XShell等软件来使用ssh远程登录，推荐使用软件登录）==

![截屏2021-11-26 下午11.57.54](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.57.54.png)

可以看到触发器生效，能听到警报声。

![截屏2021-11-26 下午11.58.08](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-26 下午11.58.08.png)过去数分钟，警报解除，可以看到，事件被标记为已解决。

![截屏2021-11-27 上午12.07.40](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午12.07.40.png)

我们还可以点击问题描述里，选用图形查看过程。

Zabbix有图形监控，==数形结合，一目了然==，受欢迎也不是没道理的。

### ![截屏2021-11-27 上午12.09.44](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午12.09.44.png)

## 4.5、Zabbix邮件通知配置（选看）

### 4.5.1、邮箱设置

==除了要设置监控项和触发器，还需要设置额外的通知设置==。

==运维人员是人，不会全天候上班，但服务器一定是是全天候服务==。

如果没有设置能在公司外也能接收到警报的设置，那么服务器一旦出现异常也不能第一时间去解决，会造成巨大损失。

所以可以设置一个邮件警报，当你不再公司里也能得知服务器是否出现异常，能够第一时间去解决，避免出现更大的损失。



==这里的Zabbix邮件通知的原理是调用你的邮箱去发送警报邮件==



在Zabbix使用邮箱通知之前，==需要对邮箱进行初步设定==，此处以==Gmail==为例子。

==本篇教程不使用在中国广泛应用的QQ邮箱、163邮箱、139邮箱、189邮箱等邮箱==。

==如果想要使用国内主流邮箱来接收Zabbix的报警，可以自行百度相关教程==。

==为了保护隐私，本实验中的部分信息会作马赛克处理。==



==**2022年5月更新，Google不再支持安全性较低的应用访问权限，所以本节可以选择性观看，可以换成其他邮箱做，除了邮箱设置，Zabbix软件内的步骤大致一样**==

![image-20220514150334905](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20220514150334905.png)

进入Google账号设置，点击安全性，确保==两步验证关闭==。

==如果没有，请关闭，否则影响实验结果。==

==为了安全，在实验后要恢复两步认证！减少被盗号的风险。==

![截屏2021-11-27 上午1.53.44](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.53.44.png)

关闭两步验证后，可以看到又一个选项，叫==安全性较低的应用的访问权限==，点进去。

![截屏2021-11-27 上午1.54.54](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.54.54.png)

==如果没有开启允许安全性较低的应用，请开启，如果有，则不用理会==。

![截屏2021-11-27 上午1.44.28](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.44.28.png)

到此为止，邮箱的相关设置就完成了。

### 4.5.2、邮件发送测试

进入Zabbix网页端，点击管理——>报警媒介类型，然后==点击创建媒体类型==。

![截屏2021-11-27 上午12.24.18](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午12.24.18.png)

新开一个页面，进入Gmail中，点击==右上角的齿轮标志==，点击==所有设置==，进入到邮箱总设置中。

![截屏2021-11-27 上午1.51.38](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.51.38.png)

![image-20211128043520803](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211128043520803.png)



移到到最下面，确保IMAP开启，然后点击IMAP访问设置里的==配置说明==，打开查看官方的配置说明。

![截屏2021-11-27 上午12.28.12](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午12.28.12.png)



![截屏2021-11-27 上午12.29.08](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午12.29.08.png)

可以看到Gmail对SMTP服务器的相关配置要求如下：

![截屏2021-11-27 上午12.29.25](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午12.29.25.png)

回到Zabbix网页端中，按照Gmail的要求，相关参数如下：

==名称要一目了然的。==

==类型选电子邮件。==

==SMTP服务器端口填587。==

==SMTP服务器域名填smtp.gmail.com。==

==SMTP HELO填写gmail.com，即二级域名。==

==安全链接选STARTTLS（纯文本通信协议扩展）。==

==亲测SSL验证对端、SSL验证主机可以不勾选。==

==认证选择用户名和密码，用户名为邮箱名，密码为邮箱登录密码。==

==Message format默认不变，描述可以不写==。

==确认无误后点击添加==。

![截屏2021-11-27 上午1.55.25](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.55.25.png)



回到报警媒介类型中可以看到新添加的报警媒介，点击==测试==

![截屏2021-11-27 上午1.56.11](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.56.11.png)

编写一封邮件，然后点击测试，==如果出现Media type test succefful==，则证明邮件发送测试成功

![截屏2021-11-27 上午1.50.32](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.50.32.png)

可以去到邮箱中查看，消息一摸一样，证明邮件发送测试成功。

![截屏2021-11-27 上午1.57.00](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午1.57.00.png)



### 4.5.3、邮件通知设置

#### 4.5.3.1、Zabbix用户添加

点击左边功能栏的管理 ——> 用户，点击==创建用户==

![截屏2021-11-27 上午2.00.30](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.00.30.png)

==别名填写要一目了然==。

点击==群组==，选择==Zabbix administration==，再点击==蓝色的选择==。

![截屏2021-11-27 上午2.03.41](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.03.41.png)

==密码可以填的很简单==~~，比如123456~~。

==刷新和每行页数可以默认不改==。

==先不着急点添加，先点击报警媒介==。

![截屏2021-11-27 上午2.04.24](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.04.24.png)

==点击添加==

![截屏2021-11-27 上午2.06.14](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.06.14.png)



类型==选择前面设定好的媒体类型==。

收件人填写==自己的邮箱地址==。

==勾选已启用==。

==其他可以默认不改==。

==点击添加，完成报警媒介的添加==。

==到这里还是别着急点击添加用户，因为还有东西要设置==。

![截屏2021-11-27 上午2.05.59](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.05.59.png)

点击==权限==，将用户类型选为==超级管理员==。

![截屏2021-11-27 上午2.07.04](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.07.04.png)

==用户的基本设置、报警媒介、权限设置完毕，确认无误后，点击添加==

#### 4.5.3.2、Zabbix动作添加

点击左边功能栏的配置——>动作，点击==新建动作==。

![截屏2021-11-27 上午2.07.56](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.07.56.png)

==动作名称要一目了然==。

==勾选已启用==。

![截屏2021-11-27 上午2.09.34](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.09.34.png)

点击条件，类型选择==触发器示警度==，"操作者"选择==等于==，严重性选==信息==。

==这里出现了渣翻，这里的操作者我猜是operator翻译过来的，应该翻译成运算符！！！==

![截屏2021-11-27 上午2.12.19](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.12.19.png)

按照上面的方法，连续添加，类型和“操作者”不变，更改严重性，更改成如图所示的条件，并把计算方式换成==或==。

==先不要急着点操作，还有其他要配置==。

![截屏2021-11-27 上午2.12.51](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.12.51.png)

点击操作，这里需要配置操作和恢复操作。

![截屏2021-11-27 上午2.13.23](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.13.23.png)

点击操作，点击在==send to users==配置内的==添加==按钮。

![截屏2021-11-27 上午2.14.17](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.14.17.png)

选择==前面设置好的用户==。

![截屏2021-11-27 上午2.14.04](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.14.04.png)

勾选==custom message（自定义内容）==，主题和消息写入提前准备好的内容，模版如下：

```java
/*
此处模版内容大量使用宏，如果想看更多Zabbix支持的宏，可以到下列链接查看
https://www.zabbix.com/documentation/5.0/zh/manual/appendix/macros/supported_by_location

以下为模版：

主题:
故障{TRIGGER.STATUS},服务器:{HOSTNAME1}发生: {TRIGGER.NAME}故障!

消息:
告警主机:{HOSTNAME1} 
告警时间:{EVENT.DATE} {EVENT.TIME} 
告警等级:{TRIGGER.SEVERITY}
告警信息: {TRIGGER.NAME} 
告警项目:{TRIGGER.KEY1} 
问题详情:{ITEM.NAME}:{ITEM.VALUE} 
当前状态:{TRIGGER.STATUS}:{ITEM.VALUE1} 
事件ID:{EVENT.ID}

*/
```

![截屏2021-11-27 上午2.15.12](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.15.12.png)

按照上述在“操作”中的流程，设置==恢复操作==，==custom message（自定义内容）==填入自定义内容，==写入一些能看出服务器恢复原状的内容==。

![截屏2021-11-27 上午2.23.01](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.23.01.png)

设置完动作的基本设置、操作设置，确认无误后点击==最下面的添加==。

![截屏2021-11-27 上午2.23.15](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.23.15.png)

可以看到，动作已经添加，能够看到条件和相关操作。

![截屏2021-11-27 上午2.23.38](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.23.38.png)

接下来可以进行邮件通知接收测试了。

#### 4.5.3.3、接收警报邮件

此处开启macOS自带的终端，开启多个终端窗口，==使用ssh远程登录来模拟用户登录==，过了没多久，就收到了警报邮件，可以看到邮件内容与设置模版相符，返回的信息也很准确，可以证明邮件通知的“警报设置”配置成功。

![截屏2021-11-27 上午2.25.40](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.25.40.png)

#### 4.5.3.4、接收警报解除邮件

当我们等了一会，关闭了好几个ssh连接后，过了数分钟，就收到了警报解除邮件，可以看到邮件内容与设置模版相符，可以证明邮件通知的”警报解除设置“配置成功。

![截屏2021-11-27 上午2.34.00](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.34.00.png)

我们可以点击问题中的==动作==，查看Zabbix客户端的相关动作，可以看到警报发生、警报邮件发送、警报解除、警报邮件解除的时间，可以看出发送邮件的速度还是相当快的，证明==邮件通知很有必要设置==。

![截屏2021-11-27 上午2.34.56](/Users/lamchingkeung/Desktop/zabbix_screenshot/截屏2021-11-27 上午2.34.56.png)



# 5、Apache的安装与简单应用

## 5.1、Apache的简介与趣闻

### 5.1.1、Apache简介

在WEB上，我们常说的Apache是指==Apache HTTP Server==，是一款==免费开源的跨平台Web服务器软件==。

可以==在大多数电脑操作系统中运行==。由于其==跨平台==和==安全性==被广泛使用，是==最流行的Web服务器软件之一==。

它==快速==、==可靠==并且可==通过简单的API扩展，将Perl/Python/PHP等解释器编译到服务器中==。

官方网站为https://httpd.apache.org。

官方文档为https://httpd.apache.org/docs/2.4/zh-cn/

==官方文档的汉化只在表面，请做好“啃生肉”的准备==。

有一个常见的WEB组合==LAMP——Linux、Apache、MySQL、PHP==，里面就有Apache。

当然，==Apache占据市场很大，但也不是完全垄断==，它的==对手有Nginx、IIS、Cloudflare、LiteSpeed等等==。

下图是W3Techs的Web 服务器的使用统计，链接https://w3techs.com/technologies/overview/web_server，可以看到经过了那么多年，Apache依旧名列前茅，Nginx仅以些许优势胜过Apache，所以Apache还是很值得学习与应用的。

![image-20211130014244391](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211130014244391.png)

### 5.1.2、Apache背后的趣闻

Apache这个名字背后的故事还是值得说一说的。

其中一种说法是==Apache这个命名是根据北美当地的一支印第安部落而来==，这支部落以高超的军事素养和超人的忍耐力着称，19世纪后半期对侵占他们领土的入侵者进行了反抗，==为了对这支印第安部落表示敬仰之意，取该部落名称（Apache）作为服务器名==。

另一个有意思的说法是，在美国国家超级计算机应用中心有一个HTTP服务器，而Apache的开发小组不断地修正、打补丁（Patchy）的产物，==被戏称为“A Patchy Server”（补丁服务器）==。==“A Patchy”与“Apache”是谐音，故最后正式命名为“Apache Server”==。

当然，以上这两个说法Apache基金会都认可。

## 5.2、Apache的安装

此处Apache的安装，==使用yum与源码包安装相结合==的方式相结合，并==精简一些设置==来完成安装。

### 5.2.1、安装依赖

使用==`yum -y install pcre-devel libxml2 expat-devel gcc-*`==

~~(图1中打错了libxml2，所以后面图2补上libxml2的安装)~~

![截屏2021-11-29 上午10.28.06](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.28.06.png)

![截屏2021-11-29 上午10.34.41](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.34.41.png)

==以上几个安装包总计大小1.9G，请在良好的网络环境下进行，安装过程请耐心等待，不要着急。==

### 5.2.2、安装apr

使用命令==`wget https://dlcdn.apache.org//apr/apr-1.7.0.tar.gz --no-check-certificate`==下载apr的源码包，加上==`--no-check-certificate`==是为了避开证书认证直接下载。

![截屏2021-11-29 上午10.38.48](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.38.48.png)

使用命令==`tar -zxvf apr-1.7.0.tar.gz`==解压源码包。

使用命令==`cd apr-1.7.0`==打开解压目录，使用命令==`./configure --prefix=/usr/local/apr`==对使用源码包安装的软件环境检测是否能安装，同时可以做一个提前的配置，这里除了对安装环境的检查，后面的参数==--prefix=/usr/local/apr==将安装目录定为==/usr/local/apr==，只要没有出现error，即可证明检查无误可以安装。

![截屏2021-11-29 上午10.42.21](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.42.21.png)

![截屏2021-11-29 上午10.42.40](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.42.40.png)

使用==`make `==命令进行编译，然后使用==`make install`==进行安装。

### ![截屏2021-11-29 上午10.56.33](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.56.33.png)5.2.3、安装apr-util

使用命令==`wget https://dlcdn.apache.org//apr/apr-util-1.6.1.tar.gz --
no-check-certificate`==下载apr-util源码包。

![截屏2021-11-29 上午10.57.13](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.57.13.png)

使用命令==`tar -zxvf apr-util-1.6.1.tar.gz`==解压源码包。

使用命令==`cd apr-util-1.6.1/`==进入源码包目录

使用命令==`./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/`==进行环境检查并做相关配置，==`--prefix=/usr/local/apr-util`==指定apr-util的安装目录，==`--with-apr=/usr/local/apr/`==指定依赖的apr目录。

![截屏2021-11-29 上午10.58.24](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.58.24.png)

使用命令==`make && make install`==编译并安装。

![截屏2021-11-29 上午10.56.33](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.56.33.png)

### 5.2.4、安装apr-iconv

使用命令==`wget https://dlcdn.apache.org//apr/apr-iconv-1.2.2.tar.gz --
no-check-certificate`==下载apr-iconv的源码包。

![截屏2021-11-29 上午10.57.13](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.57.13.png)

使用命令==`./configure --prefix=/usr/local/apr-iconv -- with-apr=/usr/local/apr`==进行安装环境检查并做相关配置，==`--prefix=/usr/local/apr-util`==指定apr-iconv的安装目录，==`--with-apr=/usr/local/apr/`==指定依赖的apr目录

![截屏2021-11-29 上午10.58.24](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午10.58.24.png)

不出现error则使用==`make && make install`==进行编译和安装

### 5.2.5、安装Apche

使用命令==`wget https://dlcdn.apache.org//httpd/httpd-2.4.51.tar.gz --
no-check-certificate`==使用

![截屏2021-11-29 上午11.04.48](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.04.48.png)

使用==`tar -zxvf httpd-2.4.51.tar.gz`==解压Apache的源码包

使用==`cd httpd-2.4.51/`==打开源码包目录

使用一条很长的命令==`./configure --prefix=/usr/local/apache --enable-mpms-shared=all --with-mpm=event --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-so --enable-remoteip --enable-proxy --enable-proxy-fcgi --enable-proxy-uwsgi --enable-deflate=shared --enable-expires=shared --enable-rewrite=shared --enable-cache --enable-file-cache --enable-mem-cache --enable-disk-cache --enable-static-support --enable-static-ab --disable-userdir --enable-nonportable-atomics --disable-ipv6 --with-sendfile`==，除了进行环境检查，以下是自定义项目的详解：

```shell
--prefix=/usr/local/apache 指定安装目录 
--enable-mpms-shared=all --with-mpm=event 开启动态MPM切换
--with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util 指定依 赖包apr apr-util安装路径
--enable-so 打开so模块，so模块是用来提dso支持的 apache 核心模块
--enable-remoteip 支持基于客户端IP做访问控制
--enable-proxy --enable-proxy-fcgi --enable-proxy-uwsgi 启用代理支持PHP、Python网站
--enable-deflate=shared			开启压缩
--enable-expires=shared		  开启客户端缓存
--enable-rewrite=shared     开启URL重写
--enable-cache --enable-file-cache --enable-mem-cache --enable-disk-cache 开启服务器缓存
--enable-static-support    开启静态链接
--enable-static-ab				使用静态连接编译ab - apache，http 服务器性能测试工具 
--disable-userdir         禁用用户主目录提供页面访问
--enable-nonportable-atomics 对新式CPU支持，支持原子的比较交换(compare-and -swap, CAS)操作指令 
--disable-ipv6						禁用IPV6
--with-sendfile						开启sendfile 0复制机制
```

如果没有安装==zlib-devel==，上述的命令会出错，所以要使用==`yum install zlib-devel`==安装 。

![截屏2021-11-29 上午11.34.03](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.34.03.png)

安装==alib-devel==后，再使用==`./configure --prefix=/usr/local/apache --enable-mpms-shared=all --with-mpm=event --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-so --enable-remoteip --enable-proxy --enable-proxy-fcgi --enable-proxy-uwsgi --enable-deflate=shared --enable-expires=shared --enable-rewrite=shared --enable-cache --enable-file-cache --enable-mem-cache --enable-disk-cache --enable-static-support --enable-static-ab --disable-userdir --enable-nonportable-atomics --disable-ipv6 --with-sendfile`==，可以看到检查出来的结果是能够显示出部分配置的。

![截屏2021-11-29 上午11.26.07](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.26.07.png)

使用==`make && make install`==安装Apache。

![截屏2021-11-29 上午11.29.13](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.29.13.png)

### 5.2.6、安装tree

使用命令==`yum -y install tree`==安装tree软件包（一个能实现树形图查看文件目录的软件）。

![截屏2021-11-29 上午11.31.07](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.31.07.png)

使用命令==`tree -L 1 /usr/local/apache/`==来测试新安装的tree插件，可以看到Apache目录下有以下文件夹，树形展示看着比较美观。

![截屏2021-11-29 上午11.31.20](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.31.20.png)

Apache目录下文件夹作用如下：

![image-20211130151933392](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211130151933392.png)



### 5.2.7、Apache启动测试

使用命令==`systemctl stop firewalld.service`==、==`setenforce 0`==分别关闭防火墙和SELinux

![截屏2021-11-29 上午11.32.20](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.32.20.png)



使用命令==`tree /usr/local/apache/bin/`==查看Apache的bin目录。

==ab用于压力测试==。

==apachectl用于管理Apache==。

==apxs是Apache的拓展工具，将第三方工具转为Apache的模块==。

==httpd是守护进程==。

![截屏2021-11-29 上午11.33.05](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.33.05.png)

使用命令==` ./apachectl`==测试启动Apache，可以看到提示你需要配置ServerName，并检查了一下配置文件给出语法OK。

![截屏2021-11-29 上午11.35.08](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.35.08.png)

使用命令==`  /usr/local/apache/bin/httpd`==测试再次启动Apache，会提示httpd已经在运行

![截屏2021-11-29 上午11.36.14](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.36.14.png)

使用命令==`netstat -luntp | grep httpd`==可以看到80端口开启，用于httpd服务

![截屏2021-11-29 上午11.36.51](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.36.51.png)

查询一个==用于关闭服务的软件——killall==，使用命令==`yum search killall`==查找软件包的名称，这个killall软件的安装软件报名交==psmisc.x86_64==

![截屏2021-11-29 上午11.37.20](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.37.20.png)

使用命令==` yum -y install psmisc.x86_64`==安装psmisc.x86_64，安装之后

![截屏2021-11-29 上午11.38.06](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.38.06.png)

使用==`killall httpd`==测试是否能够关闭httpd进程，如果返回空则已经执行，若返回不存在则进程没开启。

![截屏2021-11-29 上午11.38.28](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.38.28.png)



使用命令==`yum -y install elinks`==安装enlinks

![截屏2021-11-29 上午11.39.03](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.39.03.png)

==如果关闭了httpd进程，则此处需要重新开启httpd进程==

使用==`elinks http://localhost -dump`==访问网页并仅返回文本，可以看到文本"It works!"。

![截屏2021-11-29 上午11.39.58](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.39.58.png)

然后在物理机浏览器访问服务器，可以看到相同的文字。

![截屏2021-11-29 上午11.40.43](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 上午11.40.43.png)

到这里，Apache的安装完成了，接下来按自己的需求，配置自己需要的东西。

## 5.3、Apache的简单应用——多域名

首先使用命令==`cd /usr/local/apache/conf/`==进入Apache的配置目录下，使用命令==`vim httpd.conf`==

编辑==httpd.conf==，定位到ServerName那一行，==自定义修改ServerName==。

![截屏2021-11-29 下午2.22.23](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午2.22.23.png)

使用==`grep "Include" /usr/local/apache/conf/httpd.conf`==命令查看是否有开启虚拟主机，可以看到httpd-vhost.conf的那一行==注释掉了==，为了实现多域名，这一项需要打开。

![截屏2021-11-29 下午2.32.45](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午2.32.45.png)

使用命令==`vim httpd.conf`==编辑==httpd.conf==，定位到479行，把井号去掉。

![截屏2021-11-29 下午2.37.32](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午2.37.32.png)

目前我们要进行的多域名配置有三种：

==1、多个IP地址、单个端口==

==2、单个IP地址、多个端口==

==3、单个IP地址、单个端口==

==⚠️注意，这三个多域名配置没有最好和最坏，在实际的工作环境中需要对现有配置进行判断然后再配置==。

### 5.3.1、多个IP地址、单个端口的多域名配置

首先，使用命令==`mkdir /usr/local/apach/htdocs/master`==、==`mkdir /usr/local/apach/htdocs/sercant`==创建两个站点文件夹

![截屏2021-11-29 下午3.05.44](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午3.05.44.png)

使用==`vim /usr/local/apach/htdocs/master/index.html`==，在站点文件夹中新创建一个index.html文件，写入自定义的内容。

![截屏2021-11-29 下午3.26.23](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午3.26.23.png)

同样的，使用==`vim /usr/local/apach/htdocs/servant/index.html`==，在站点文件夹中新创建一个index.html文件，写入自定义的内容。

![截屏2021-11-29 下午3.26.51](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午3.26.51.png)

在虚拟机配置中，点击==添加设备==，再点击网络适配器，添加两个网卡，==网卡配置默认NAT==。

![截屏2021-11-29 下午9.29.07](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午9.29.07.png)

![截屏2021-11-29 下午9.29.30](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午9.29.30.png)

新建立的网卡分别是ens37、ens38

使用命令==`vim /etc/sysconfig/network-scripts/ifcfg-ens37`==、==`vim /etc/sysconfig/network-scripts/ifcfg-ens38`==在网卡配置目录下生成一个ens37、ens38网卡的配置文件，具体的目录可以去看ens33网卡的，复制过来，然后修改其中的一些参数就行了。

==其中要注意的参数是：BOOTPROTO、UUID、NAME、DEVICE、IPADDR、NETMASK、GATEWAY，这些需要按照本机的配置来填写==。

![截屏2021-11-29 下午8.32.28](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午8.32.28.png)

![截屏2021-11-29 下午8.32.43](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午8.32.43.png)

配置完成之后，使用命令==`systemctl restart network.service`==重启网络，使用==`ifconfig`==命令可以看到新添加的网卡与配置文件的一样。

![截屏2021-11-29 下午9.28.20](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午9.28.20.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==进入虚拟主机配置文件中。

==修改VirtualHost后的IP，修改成与新配置的两个新网卡的IP一样==。

==修改DocumentRoot后的路径，路径修改为新创建的Apache站点文件夹==。

![截屏2021-11-29 下午3.20.17](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午3.20.17.png)

使用命令==`/usr/local/apache/bin/apachectl -t`==检查配置文件是否出错，==显示Syntax OK则配置无误==。

![截屏2021-11-29 下午3.20.34](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午3.20.34.png)

使用命令==`killall httpd`==关闭Apache进程、==`/usr/local/apache/bin/apachectl`==重新启动Apache。

使用==`elinks http://192.168.158.88 --dump`==、==`elinks http://192.168.158.66 --dump`==分别测试，可以看到显示的内容与站点文件夹下的index文件的内容一致，证明多IP条件下的多域名配置成功。

![截屏2021-11-29 下午9.27.18](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午9.27.18.png)

==多个IP地址、单个端口的多域名的配置的优缺点：==

==优点：只用默认的端口，用户访问很方便、不同IP能对应不同网站==。

==缺点：需要充足的公网IP，而且公网IP不便宜==。

==适合有充足公网IP的环境==。

### 5.3.2、单个IP地址、多个端口的多域名配置

这个实验==可以把上一个实验添加的其中一张网卡删掉==，使用命令==`systemctl restart network.service`==重启网络。

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==进入虚拟主机配置文件中。

==如果端口默认80，则不需要额外写Listen 配置，如果是其他端口，则需要额外写Listen==。

==Listen配置要写在====<====VirtualHost=====>====配置的上面==。

==<====VirtualHost=====>====内的IP要写为同一个，但是端口不能相同==。

![截屏2021-11-29 下午9.43.44](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午9.43.44.png)

使用命令==`/usr/local/apache/bin/apachectl -t`==检查配置文件是否出错，==显示Syntax OK则配置无误==。

使用命令==`killall httpd`==关闭Apache进程、==`/usr/local/apache/bin/apachectl`==重新启动Apache。

![截屏2021-11-29 下午9.44.18](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午9.44.18.png)

==再使用`elinks`命令进行测试的时候，域名后记得要追加端口==。

使用==`elinks http://192.168.158.66:666 --dump`==、==`elinks http://192.168.158.66：233 --dump`==分别测试，可以看到显示的内容与站点文件夹下的index文件的内容一致，证明多个端口下的多域名配置成功。

![截屏2021-11-29 下午9.45.02](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-29 下午9.45.02.png)

==同IP多端口的多域名配置的优缺点：==

==优点：能够大大节省IP，不同端口号对应不同的网站==。

==缺点：访问时需要追加端口号，影响用户体验==。

==适合内网环境==。

### 5.3.3、单个IP、单个端口的多域名配置

==到了这一个实验，可以把多余的网卡全部删除，留下系统默认的ens33网卡==。

然后使用命令==`vim /etc/hosts`==进入host文件，然后按照模版写入相同的IP地址，不同的域名。

![截屏2021-11-30 上午12.13.39](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-30 上午12.13.39.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==进入虚拟主机配置文件中，将====<====VirtualHost=====>==的内容修改成==*:80==，然后将ServerName前面的井号去掉，并==追加一个域名==。

==（亲测没有其他设置下，无法使用超过三级的域名）==

![截屏2021-11-30 上午12.13.53](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-30 上午12.13.53.png)

使用命令==`/usr/local/apache/bin/apachectl -t`==检查配置文件是否出错，==显示Syntax OK则配置无误==。

使用命令==`killall httpd`==关闭Apache进程、==`/usr/local/apache/bin/apachectl`==重新启动Apache。

使用==`elinks http://servant.chaldea.org --dump`==、==`elinks http://master.chaldea.org --dump`==分别测试，可以看到显示的内容与站点文件夹下的index文件的内容一致，证明同IP下的多域名配置成功。

![截屏2021-11-30 上午12.14.41](/Users/lamchingkeung/Desktop/Apache_sceenshot/截屏2021-11-30 上午12.14.41.png)

==单个IP、单个端口的多域名配置的优缺点==：

==优点：只需要一个IP地址，成本低、不同域名对应不同网站==。

==缺点：需要设立多个域名==。

==适合大部分公网环境==。



# 6、MySQL的安装与启动测试

## 6.1、MySQL安装前的准备

### 6.1.1、安装Cmake

Cmake是一个==高级可移植编译配置软件==。

使用命令==`wget https://cmake.org/files/v3.6/cmake-3.6.0-rc1.tar.gz`==下载Cmake。

使用命令==`tar -zxvf cmake-3.6.0-rc1.tar.gz`==解压Cmake源码包。

使用命令==`cd cmake-3.6.0-rc1/`==进入Cmake目录。

使用命令==`./configure`==直接检查环境。

![截屏2021-11-30 下午7.50.24](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午7.50.24.png)

使用命令==`make && make install`==编译安装Cmake。

使用==`cmake --version`==查看Cmake版本，如果有显示，则安装成功

![截屏2021-11-30 下午7.56.11](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午7.56.11.png)

### 6.1.2、下载Boost库

Boost库是==一个可移植的C库==，作为标准库的后备，是C标准化进程的开发引擎之一。

使用命令==`wget https://sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz --no-check-certificate`==获取1.59.0版本的Boost 。

然后使用命令==`tar -zxvf boost_1_59_0.tar.gz`==解压Boost压缩包

使用命令==`mv boost_1_59_0 /usr/local/boost`==将解压的Boost库==移到/usr/local/boost==目录中。

### 6.1.3、安装Bison、Ncures-devel

使用命令==`yum -y install ncurses-devel bison`==安装Bison、Ncures-devel。

![截屏2021-11-30 下午7.59.03](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午7.59.03.png)

## 6.2、MySQL的安装

### 6.2.1、MySQL源码包的准备

MariaDB是MySQL的社区版，而MySQL本身又有企业版和社区版（被收购之后就推出企业版了）。

==本次实验选择安装社区版，当前（2021-12-01）最新版本为8.0.27，我们选择版本5.7.24==。

==MySQL官网：https://www.mysql.com==。

进入MySQL官网，==点击DOWNLOADS==。

![截屏2021-12-01 上午11.35.35](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-12-01 上午11.35.35.png)

==点击MySQL Community(GPL) Download==进入社区版的下载界面。

![截屏2021-12-01 上午11.36.16](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-12-01 上午11.36.16.png)

进入到产品选择界面，点击==MySQL Community Server==。

![截屏2021-12-01 上午11.36.49](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-12-01 上午11.36.49.png)

然后==点击Archives==查看历史版本。

![截屏2021-12-01 上午11.37.52](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-12-01 上午11.37.52.png)

==Product Version选择5.7.24，Opertaing System选择Source Code（开源代码），OS Version选择Generic Linux（Architecture Independent）==。

弹出下载选择，选择==Compressed TAR Archive==。

==此处可以直接下载然后拖到Linux虚拟机上，也可以在Linux虚拟机上使用wget命令获取源码包==。

![截屏2021-12-01 上午11.38.50](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-12-01 上午11.38.50.png)

### 6.2.2、MySQL的安装

使用命令==`tar -zxvf mysql-5.7.24.tar.gz`==解压MySQL的源码包。

使用命令==`cd mysql-5.7.24/`==进入MySQL的解压目录。

使用命令==`useradd -s /sbin/nologin -r mysql`====创建一个无法登录的root用户——mysql==，方便后续的安装。

使用命令==`mkdir -vp /usr/local/mysql/data`==创建新的文件夹，==整个mysql是MySQL的安装目录，而mysql文件夹内的data目录用于存放MySQL的数据==。

使用命令==`cmake . -DCMAKE\_INSTALL\_PREFIX=/usr/local/mysql -DMYSQL\_DATADIR=/usr/local/mysql/data/ -DMYSQL\_UNIX\_ADDR=/usr/local/mysql/mysql.sock  -DWITH\_INNOBASE\_STORAGE\_ENGINE=1 -DWITH\_MYISAM\_STORAGE\_ENGINE=1  -DENABLED\_LOCAL\_INFILE=1 -DEXTRA\_CHARSETS=all -DDEFAULT\_CHARSET=utf8 -DDEFAULT\_COLLATION=utf8\_general\_ci -DMYSQL\_USER=mysql -DWITH\_DEBUG=0 -DWITH\_EMBEDDED\_SERVER=1 -DDOWNLOAD\_BOOST=1  -DENABLE\_DOWNLOADS=1 -DWITH\_BOOST=/usr/local/boost`==调用Cmake检查MySQL的安装环境并进行安装参数配置。

以下是上述命令部分参数配置的简介：

```shell
-DCMAKE_INSTALL_PREFIX=/usr/local/mysql 指定安装路径 
-DMYSQL_DATADIR=/usr/local/mysql/data/ 指定数据目录 
-DMYSQL_UNIX_ADDR=/usr/local/mysql/mysql.sock 指定sock文件路径 
-DWITH_INNOBASE_STORAGE_ENGINE=1 安装Innodb存储引擎 
-DWITH_MYISAM_STORAGE_ENGINE=1 安装myisam存储引擎 
-DENABLED_LOCAL_INFILE=1 允许使用Load data命令从本地导入数据 
-DEXTRA_CHARSETS=all    安装所有字符集
-DDEFAULT_CHARSET=utf8  设定默认字符集utf-8
-DDEFAULT_COLLATION=utf8_general_ci 设定校验字符
-DMYSQL_USER=mysql 设定mysql用户名
-DWITH_DEBUG=0 关闭debug
-DWITH_EMBEDDED_SERVER=1 生成一个libmysqld.a(.so)的库，这个库同时集成了mysql服务与客户端API
-DDOWNLOAD_BOOST=1 -DENABLE_DOWNLOADS=1 -DWITH_BOOST=/usr/local/boost 允许boost、允许下载boost库文件
```

使用命令==`make && make install`==编译安装MySQL。

==然后等待半个小时甚至是更长时间，因为MySQL的编译安装需要很长时间==。

## 6.3、MySQL测试

### 6.3.1、MySQL启动前的一些工作

#### 6.3.1.1、更改MySQL文件

==经历了漫长的安装，现在进入到启动前的工作==。

使用命令==`chmod 755 /etc/init.d/mysql`==将==MySQL的启动文件的权限更改为rwx-rx-rx==。 

使用命令==`chown mysql.mysql /usr/local/mysql/ -R`==将==mysql文件夹的用户所属和用户组所属均改为mysql==，==-R是表示使用递归处理，将指定目录下的所有文件及子目录一并处理==。

以下四条命令为对MySQL的目录进行链接操作，==-s表示对源文件建立软链接，-f强制删除移存在的文件，即强制建立软链接==。

```shell
#将MySQL安装目录下的bin文件夹链接到/usr/bin目录下，使得能够用命令运行MySQL
ln -sf /usr/local/mysql/bin/* /usr/bin/
#将MySQL的目标文件、库文件链接到/usr/lib/目录下
ln -sf /usr/local/mysql/lib/* /usr/lib/
#将MySQL程序执行的命令库文件链接到usr/local/目录下
ln -sf /usr/local/mysql/libexec/*  /usr/local/libexec
#将MySQL的用户操作命令手册（man1）的文件链接到/usr/share目录下
ln -sf /usr/local/mysql/share/man/man1/* /usr/share/man/man1
#将MySQL的系统管理命令手册（man8）的文件链接到/usr/share目录下
ln -sf /usr/local/mysql/share/man/man8/* /usr/share/man/man8
```

![截屏2021-11-30 下午10.47.14](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午10.47.14.png)

#### 6.3.1.2、修改MySQL配置文件

使用命令==`grep -v "^#|^$" /etc/my.cnf`==查看MySQL的配置文件。

可以看到，==mysqld和mysqld_safe进程目录还是默认的目录==，所以需要修改目录以达到快速启动。

![截屏2021-11-30 下午10.47.28](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午10.47.28.png)

使用命令==`vim /etc/my.cnf`==编辑MySQL配置文件，修改成如下图所示：

![截屏2021-11-30 下午10.46.24](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午10.46.24.png)

### 6.3.2、MySQL的初始化

使用命令==`/usr/local/mysql/bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql/ --datadir=/usr/local/mysql/data/`==对MySQL进行初始化

以下是该条命令的简介：

```shell
#启动mysql
/usr/local/mysql/bin/mysqld 
#表明进行初始化
--initialize 
#指定用户为mysql
--user=mysql
#指定数据库的目录为/usr/local/mysql/ 
--basedir=/usr/local/mysql/ 
#指定数据目录为/usr/local/mysql/data/
--datadir=/usr/local/mysql/data/
```

可以看到初始化完成之后会生产一个==复杂度很高的默认root密码==，==记住这个密码，到后面启动数据库设置的时候会用到==。

![截屏2021-11-30 下午10.20.47](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午10.20.47.png)

==初始化之后会生成一些必要的文件==。

![截屏2021-11-30 下午9.25.15](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午9.25.15.png)

### 6.3.3、MySQL的启动与连接测试

#### 6.3.3.1、MySQL的启动

使用命令==`/etc/init.d/mysql start`==启动MySQL

看到==Starting MySQL. SUCCESS!==则证明前面的配置没有出问题，启动成功，若报错，则按照报错信息去解决问题。

![截屏2021-11-30 下午10.21.31](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午10.21.31.png)

使用命令==`mysql_secure_installation`==进行MySQL的安全设置：

```shell
Securing the MySQL server deployment.

#进入后要输入root密码才能继续设置，这个root密码就是初始化中生成的密码，如果不记得的话可以翻一下记录（如果记录有的话）。
Enter password for user root: 

#这里提示你root用户的密码过期，需要设置一个新的root密码
The existing password for the user account root has expired. Please set a new
password.

New password:

Re-enter new password:

#需要设置密码强度检验插件吗？此处选n。
VALIDATE PASSWORD PLUGIN can be used to test passwords
and improve security. It checks the strength of password
and allows the users to set only those passwords which are
secure enough. Would you like to setup VALIDATE PASSWORD plugin?

Press y|Y for Yes, any other key for No: n

#这里再次提示你是否要更改root密码？如果反悔了此处选y，如果上述的密码设置没有错就选n。
Using existing password for root.
Change the password for root ? ((Press y|Y for Yes, any other key for No) : y

New password:

Re-enter new password:

#是否移除匿名用户，为了安全，此处选y。
By default, a MySQL installation has an anonymous user,
allowing anyone to log into MySQL without having to have
a user account created for them. This is intended only for
testing, and to make the installation go a bit smoother.
You should remove them before moving into a production
environment.

Remove anonymous users? (Press y|Y for Yes, any other key for No) : y

Success.

#是否关闭远程链接，此处为了实验，选n，真实工作环境中这个需要选y
Normally, root should only be allowed to connect from
'localhost'. This ensures that someone cannot guess at
the root password from the network.


Disallow root login remotely? (Press y|Y for Yes, any other key for No) : n
 ... skipping.

#是否移除test数据库，此处选是
By default, MySQL comes with a database named 'test' that
anyone can access. This is also intended only for testing,
and should be removed before moving into a production
environment.

Remove test database and access to it? (Press y|Y for Yes, any other key for No) :y
 - Dropping test database...
Success.

- Removing privileges on test database...
Success.

# 是否刷新特权表，此处选是，如果不选是，以上的更改不会生效
Reloading the privilege tables will ensure that all changes
made so far will take effect immediately.
Reload privilege tables now? (Press y|Y for Yes, any other key for No) : y
Success.

All done!
```

![截屏2021-11-30 下午11.32.20](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午11.32.20.png)

![截屏2021-11-30 下午11.33.46](/Users/lamchingkeung/Desktop/MySQL_sceenshot/截屏2021-11-30 下午11.33.46.png)





# 7、PHP的安装与应用

## 7.1、PHP的安装

### 7.1.1、PHP的一些简介

~~首先，PHP是世界上最好的语言~~

PHP，全称Hypertext Preprocessor，中文名超文本预处理器，是一种==通用开源脚本语言==。

PHP有以下优点：

==适用于网络开发并可嵌入HTML中使用==，用PHP做出的动态页面与其他的编程语言相比，PHP是将程序嵌入到HTML(标准通用标记语言下的 一个应用)文档中去执行，执行效率比完全生成HTML标记的CGI要高许多。

==上手简单==，PHP的语法借鉴吸收C语言、Java和Perl等流行电脑语言的特点，所以难度相对C/C++，上手比较简单。~~写着写着就开始查函数了。~~

==根据W3Techs的报告，截至2021年9月，有78.9%的网站在使用PHP==，其中比较出名的社交网站Facebook（现在也可以改名叫meta了），就是使用PHP语言。

==经典WEB软件组合LAMP中的P，PHP就很适合做这个“P”==。

有趣的事：PHP官方文档中==曾经写入了“PHP是最好的WEB语言，那其他的语言如何呢？”==，不过到了国内传来传去，就变成了“PHP是世界上最好的语言”，然后就变成了一个经典梗。

==所以，此处提醒一下，不要随便在评论区里说“PHP是世界上最好的语言”，不然会被人身攻击、禁言甚至是封号，请谨慎发言==。

### 7.1.2、安装PHP前的一些工作

#### 7.1.2.1、安装PHP的依赖软件包

使用命令==`yum -y install epel-release`==安装epel- release软件包。

![截屏2021-12-01 上午1.19.44](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.19.44.png)

使用命令==`yum -y install gcc-c++ libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel gd net-snmp-*`==安装一系列的软件包。

![截屏2021-12-01 上午1.23.54](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.23.54.png)

#### ![截屏2021-12-01 上午1.23.17](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.23.17.png)

![截屏2021-12-01 上午1.23.26](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.23.26.png)

#### 7.1.2.2、更新libzip

==系统提供的libzip版本为1.0，安装PHP需要libzip 1.1及以上==。

使用命令==`wget https://libzip.org/download/libzip-1.5.2.tar.gz --no-check-certificate`==下载libzip 1.5.2的源码包。

![截屏2021-12-01 上午1.24.29](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.24.29.png)

使用命令==`tar -zxvf libzip-1.5.2.tar.gz`==解压libzip的源码包。

使用命令==`cd libzip-1.5.2/`==打开libzip源码包的目录。

使用命令==`mkdir build`==在源码包目录里建立一个build文件夹。

使用命令==`cd build/`==进入bulild文件夹。

使用命令==`cmake ..`==在源码包目录（即libzip源码包解压目录），生成一个Makefile文件。

![截屏2021-12-01 上午1.25.20](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.25.20.png)

使用命令==`make && make install`==根据Cmkae生成的Makefile文件==对libzip编译并安装==。

![截屏2021-12-01 上午1.25.55](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.25.55.png)



### 7.1.3、PHP源码包的下载

此处我们选择的PHP版本并不是最新的那个版本，==选的是7.3.4==，一个不算太旧的版本

![截屏2021-12-01 上午1.31.28](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.31.28.png)

==进入https://www.php.net，点击Downloads==。

![截屏2021-12-01 上午1.32.26](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.32.26.png)

然后==点击Old archives==。

![截屏2021-12-01 上午1.31.47](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.31.47.png)

在网页中，使用查找功能找版本号"7.3.4"（使用网页查找比慢慢滚动网页要快），可以看到==选择该版本以tar.gz结尾的源码包==。

==PHP的源码包可以提前下载下来拖到虚拟机，也可以在迅即使用`wget`命令下载==。

![截屏2021-12-01 上午1.33.20](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.33.20.png)

### 7.1.4、PHP的安装

使用命令==`wget https://www.php.net/distributions/php-7.3.4.tar.gz`==下载PHP 7.3.4的源码包。

![截屏2021-12-01 上午1.39.58](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.39.58.png)

使用命令==`tar -zxvf php-7.3.4.tar.gz`==解压PHP源码包，使用==`cd php-7.3.4/`==进入源码包目录。

使用命令==`vim /etc/ld.so.conf`==在etc目录下新建一个名为ld.sp.conf的文档，并写入以下内容：

```shell
#添加搜索路径到配置文件
include ld.so.conf.d/*.conf
/usr/local/lib64
/usr/local/lib
/usr/lib
/usr/lib64
```

![截屏2021-12-01 上午1.41.37](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.41.37.png)

使用命令==`ldconfig -v`==更新配置。

使用命令==`./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-mysqli=mysqlnd --enable-pdo --with-pdo-mysql=mysqlnd --with-iconv-dir=/usr/local/ --enable-fpm --with-fpm-user=www --with-fpm-group=www --with-pcre-regex --with-zlib --with-bz2 --enable-calendar --disable-phar --with-curl --enable-dba --with-libxml-dir --enable-ftp --with-gd --with-jpeg-dir --with-png-dir --with-zlib-dir --with-freetype-dir --enable-gd-jis-conv --with-mhash --enable-mbstring --enable-opcache=yes --enable-pcntl --enable-xml --disable-rpath --enable-shmop --enable-sockets --enable-zip --enable-bcmath --with-snmp --disable-ipv6 --with-gettext --disable-rpath --disable-debug --enable-embedded-mysqli --with-mysql-sock=/usr/local/mysql/ --with-apxs2=/usr/local/apache/bin/apxs`==对安装环境并进行安装参数配置。

以下是对上一条命令的简介：

```shell
#设定安装路径
---prefix=/usr/local/php 
#配置文件路径
--with-config-file-path=/usr/local/php/etc 
#设定mysql支持及客户端设置
--with-mysqli=mysqlnd --enable-embedded-mysqli 
--with-mysql-sock=/usr/local/mysql/ 
#开启php pdo,PDO一是PHP数据对象 (PHP Data Object)的缩写
--enable-pdo --with-pdo-mysql=mysqlnd 
#指定转码工具，各种字符集间的转换
--with-iconv-dir=/usr/local/ 
#开启php-fpm支持，允许以服务的方式启动PHP
--enable-fpm --with-fpm-user=www 
--with-fpm-group=www 
#允许以模块的方式启动PHP
--with-apxs2=/usr/local/apache/bin/apxs 
#开启pcre正则表达式支持
--with-pcre-regex 
#开启压缩支持
--with-zlib --with-bz2 --with-zlib-dir --enable-zip 
#开启日历支持
--enable-calendar 
#关闭PHAR支持
#PHAR (“Php ARchive”) 是PHP里类似于JAR的一种打包文件。如果你使用的是PHP 5.3或更高版本，那么Phar后缀文件是默认开启支持的。
--disable-phar 
#开启curl支持
--with-curl
#开启dba函数支持
--enable-dba
#开启xml文件库的支持，能对xml读取与查询
--with-libxml-dir
#开启ftp支持
--enable-ftp
#开启图片支持
--with-gd 
--with-jpeg-dir 
--with-png-dir 
#开启字库支持
--with-freetype-dir 
#开启gd库支持
--enable-gd-jis-conv
#开启加密支持
--with-mhash 
--enable-mbstring 
#开启opcache支持
--enable-opcache=yes 
#支持PHP进程控制支持
--enable-pcntl
#开启xml支持
--enable-xml
#关闭额外的运行库文件
--disable-rpath 
#开启shmop（一个易用的允许PHP读取、写入、创建和删除Unix共享内存段的函数集）
--enable-shmop 
#开启sockets支持
--enable-sockets 
#开启bcmath扩展的支持（一个支持大整数计算的扩展）
--enable-bcmath 
#开启snmp支持
--with-snmp 
#关闭IP6支持
--disable-ipv6 
#开启gettext的支持，编码库会用到
--with-gettext 
#关闭条是模式
--disable-debug
```

==`.configure`命令完成之后会有如下图显示的License提示和感谢语==。

![截屏2021-12-01 上午1.50.26](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午1.50.26.png)

以上配置完成之后，使用==`make & make install`==进行PHP的编译和安装。

![截屏2021-12-01 上午2.00.21](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.00.21.png)

最后，使用命令==`cp /root/php-7.3.4/php.ini-production /usr/local/php/etc/php.ini`==考虑php配置文件。

## 7.2、PHP的配置与启动

### 7.2.1、PHP模块的查看

经过前面的安装的等待，可以进行配置。

使用命令==`cd usr/local/apache/modules`==进入到apche的modules目录下。

然后使用命令==`ls | grep php`==在modules下目录查找有关php的模块，可以看到有一个叫libphp7.so的模块。

然后使用命令==`grep php7.so /usr/local/apache/conf/httpd.conf`==查看Apche主配置里有关php7.so的相关内容，可以看到有一行是提到==加载PHP7的模块==。

![截屏2021-12-01 上午2.04.50](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.04.50.png)

由此可以看出，==PHP默认是以模块方式运行的==。

### 7.2.2、PHP独立服务的配置

使用命令==`cd /usr/local/php/etc/`==进入PHP目录里的etc目录。

使用命令==`ls`==查看etc目录，可以看到PHP的四个配置文件。

![截屏2021-12-01 上午2.06.36](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.06.36.png)

使用命令==`cp php-fpm.conf.default php-fpm.conf`==将==php-fpm.conf.default文件改名为php-fpm.conf==。

然后使用命令==`vim /usr/local/php/etc/php-fpm.conf`==修改php-fpm配置文件。 

==将17行的pid配置、24行的error_log配置、99行的daemonize配置、143行的include配置前的注释符——分号去掉==。

![截屏2021-12-01 上午2.11.11](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.11.11.png)

![截屏2021-12-01 上午10.56.18](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午10.56.18.png)

![截屏2021-12-01 上午2.12.05](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.12.05.png)

![截屏2021-12-01 上午2.12.18](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.12.18.png)

使用命令==`egrep -v "^;|^$" /usr/local/php/etc/php-fpm.conf`==可以看到修改后的配置文件，有四行生效，分别是==指定进程ID==、==指定错误日志==、==开启守护进程==、==导入的配置文件==。

![截屏2021-12-01 上午10.57.24](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午10.57.24.png)

使用命令==`useradd -s /sbin/nologin -r www`==，建立一个==不能登录的root用户==——www。

![截屏2021-12-01 上午2.12.42](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.12.42.png)

使用命令==`vim /usr/local/apache/conf/httpd.conf`==更改Apche配置文件中166行的User和167的Group参数，==全部更改为www==。

![截屏2021-12-01 上午2.16.08](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.16.08.png)

### 7.2.3、PHP的启动

使用命令==`vim /etc/systemd/system/php-fpm.service`==创建php-frpm服务文件。

然后写入以下内容：

```shell
[Unit]
Description=The PHP FastCGI Process Manager
After=syslog.target network.target
[Service]
Type=simple
PIDFile=/run/php-fpm.pid
ExecStart=/usr/local/php/sbin/php-fpm --nodaemonize --fpm-config
/usr/local/php/etc/php-fpm.conf
ExecReload=/bin/kill -USR2 $MAINPID
ExecStop=/bin/kill -SIGINT $MAINPID
[Install]
WantedBy=multi-user.target
```

![截屏2021-12-01 上午2.22.02](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.22.02.png)

使用命令==`systemctl start php-fpm.service`==开启php-fpm服务。

使用命令==`systemctl enable php-fpm.service`==让php-fpm服务自启动。

![截屏2021-12-01 上午2.22.28](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.22.28.png)

使用命令==`killall httpd`==关闭Apache进程。

使用命令==`/usr/local/apache/bin/apachectl -t`==检查Apache主配置是否有错。

使用命令==`/usr/local/apache/bin/apachectl`==开启Apache进程。

使用命令==`lsof -i :80`==查看80端口，可以看到user为www。

![截屏2021-12-01 上午2.23.07](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 上午2.23.07.png)

## 7.3、PHP的集成使用

==单个软件无法直接完成发布PHP站点的任务，这需要将多个软件关联起来==。

以经典的“LAMP”为例：

 Linux:系统软件，应用软件平台。

Apache:接受用户请求，处理静态数据，响应用户请求。

PHP:处理用户的PHP请求。

MySQL:存储数据。

### 7.3.1、PHP的两种工作模式

==PHP的工作方式有两种==：==一种是以模块方式运作，一种是以独立服务方式运作==。

```java
/*
PHP作为模块使用：

优点：
1、PHP安装后的默认为以模块使用，配置简单。
2、容易更新与安装。
缺点：
1、与Apache绑在一块，Apache不开不能运行。
2、增加了Apache子进程内存开销。
3、Apache接到PHP请求才唤醒PHP请求，启动速度慢。
4、更改了php.ini后要重启Apache才能生效。
---------------------------–--––-–––------------------------------
PHP作为服务使用：
优点：
1、能常驻内存，Apache接受到了PHP请求直接传给PHP服务处理，速度快。
2、可配置项多。
3、占用内存少。
缺点：
配置复杂。

*/
```

### 7.3.2、PHP作为模块的集成使用

#### 7.3.2.1、PHP作为模块使用的配置

使用命令==`vim /usr/local/apache/conf/httpd.conf`==

==注释LoadModule php7_module modules/libphp7.so，不加载libphp7.so模块==。

![截屏2021-12-02 上午12.15.35](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.15.35.png)

然后在配置mod_proxy_html模块前添加配置==`Include conf/extra/php.conf`==。

![截屏2021-12-01 下午11.12.44](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 下午11.12.44.png)

使用命令==`vim /usr/local/apache/conf/extra/php.conf`==创建子配置文件

添加以下两行内容：

```shell
#加载libphp7.so模块
LoadModule php7_module modules/libphp7.so
#让Apache.php支持对以.php结尾的文件的解析
AddType application/x-httpd-php .php
```

![截屏2021-12-03 上午3.43.33](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-03 上午3.43.33.png)

7.3.2.2、phpinfo函数测试

使用命令==`vim /usr/local/apache/htdocs/master/phpinfo.php`==在网站目录下生成一个名为phpinfo.php的文件，内容中写入：

```php
//调用phpinfo函数，查看PHP各项参数信息
<?php
phpinfo();
?>
```

![截屏2021-12-01 下午11.37.45](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-01 下午11.37.45.png)

使用命令==`killall httpd`==关闭Apache进程。

使用命令==`/usr/local/apache/bin/apachectl -t`==检查Apache主配置是否有错。

使用命令==`/usr/local/apache/bin/apachectl`==开启Apache进程。

输入==192.168.158.2/phpinfo.php==，可以看到PHP的各项参数信息，证明PHP作为模块使用配置成功。

![截屏2021-12-02 上午12.19.50](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.19.50.png)

#### 7.3.2.3、PHP与数据库连接测试

使用命令==`vim /usr/local/apache/htdocs/web1/php_mysql.php`==创建一个名为php_mysql.php的文件。

在这个文件下编写一段用于测试链接数据库是否成功的php文件：

```php
<?php
//说明数据库的IP地址、数据库用户名、数据库密码
$servername = "127.0.0.1";
$username = "root";
$password = "yajyu114514";
// 创建连接
$conn = new mysqli($servername, $username, $password);
// 检测连接
if ($conn->connect_error) {
		die("connection faild: " . $conn->connect_error); }
echo "connection successful"; 
echo "</br>";
echo "</br>";
echo $showtime=date("Y-m-d H:i:s");
?>
```

![截屏2021-12-02 上午12.49.51](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.49.51.png)

输入==192.168.158.2/php_mysql.php==，可以看到页面显示数据库连接成功，证明PHP作为模块连接数据库配置成功。

![截屏2021-12-02 上午12.50.06](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.50.06.png)

### 7.3.3、PHP作为独立服务的集成使用

当PHP作为独立服务模式使用时。

==Apache有两种方式将PHP请求传给PHP==：

一种是==TCP/IP方式==，一种是==socket方式==。

如果==同时有Apache和PHP==，==建议使用socket方式，系统开销小，并发量也大==。

==socket方式再细分还有两种：==

==一种是tcp socket模式、一种是unix socket模式==。

#### 7.3.3.1、tcp socket模式

使用命令==`egrep -v "^;|^$" /usr/local/php/etc/php-fpm.d/www.conf `==查看php-fpm文件夹内的www.conf配置文件是否配置正确。

![截屏2021-12-02 上午12.51.19](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.51.19.png)

使用命令==`netstat -luntp | grep php`==查看php-fpm服务是否开启。

![截屏2021-12-02 上午12.51.51](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.51.51.png)

使用命令==`vim /usr/local/apache/conf/httpd.conf`==进入Apache的主配置文件。

注释掉==`Include conf/extra/php.conf`==，然后注释掉的语句后追加==`Include conf/extra/php-fpm.conf`==。

![截屏2021-12-02 上午12.54.05](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.54.05.png)

使用命令==`vim /usr/local/apache/conf/extra/php-fpm.conf`==新建一个名为php-fpm.conf文件。

然后写入以下的语句：

```shell
#导入两个代理模块
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
```

![截屏2021-12-02 上午12.54.58](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.54.58.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==编辑虚拟主机配置文档。

写入两段配置：

```shell
<Directory "/usr/local/apache/htdocs/master">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

<IfModule dir_module>
    DirectoryIndex index.php index.html
</IfModule>

<FilesMatch \.php$>
         SetHandler "proxy:fcgi://127.0.0.1:9000"
</FilesMatch>
```

![截屏2021-12-02 上午12.57.19](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.57.19.png)

使用命令==`killall httpd`==关闭Apache进程。

使用命令==`/usr/local/apache/bin/apachectl -t`==检查Apache主配置是否有错。

使用命令==`/usr/local/apache/bin/apachectl`==开启Apache进程。

进入浏览器输入==192.168.158.2/phpinfo.php==进行检验，能打开则tcp socket模式配置成功。

![截屏2021-12-02 上午12.58.03](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.58.03.png)



#### 7.3.3.2、unix socket模式

==如果上面已经配置tcp socket模式，则可以跳过此部==

==如果没有，请做以下的步骤==：

1、使用命令==`vim /usr/local/apache/conf/httpd.conf`==进入Apache的主配置文件。

注释掉==`Include conf/extra/php.conf`==，然后注释掉的语句后追加==`Include conf/extra/php-fpm.conf`==。

![截屏2021-12-02 上午12.54.05](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.54.05.png)

2、使用命令==`vim /usr/local/apache/conf/extra/php-fpm.conf`==新建一个名为php-fpm.conf文件。

然后写入以下的语句：

```shell
#导入两个代理模块
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
```

![截屏2021-12-02 上午12.54.58](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午12.54.58.png)

==以上步骤做完之后可以进入正式的unix socket配置==：

使用命令==`/usr/local/php/etc/php-fpm.d/www.conf`==编辑php-fpm文件夹内的www.conf配置文件。

将配置文件中的==`listen = 127.0.0.1:9000`==注释掉。

然后在注释的listen语句下追加==`listen = /usr/local/php/etc/php-fpm.socket`==。

其他红框语句要保证没有被注释。

![截屏2021-12-02 上午1.07.42](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午1.07.42.png)

使用语句==`egrep -v "^;|^$" /usr/local/php/etc/php-fpm.d/www.conf`==确认是否开启了正确的配置，如果没有，返回上一步继续配置。

![截屏2021-12-02 上午1.06.56](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午1.06.56.png)

使用命令==`systemctl restart php-fpm.service`==重启php-fpm服务。

使用命令==`netstat -luntp | grep php`==查看9000端口是否开启，如果返回空，则可以进行下一步操作。

使用命令==`ls /usr/local/php/etc/`==查看/usr/local/php/etc目录下，==可以看到生成了一个socket文件==。

![截屏2021-12-02 上午1.12.07](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午1.12.07.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==编辑虚拟主机配置。

在VirtualHost配置中追加一段以下的配置：

```shell
<FilesMatch "\.php$">
    # Unix sockets require 2.4.7 or later
    SetHandler  "proxy:unix:/usr/local/php/etc/php-fpm.socket|fcgi://localhost/"
</FilesMatch>
```

![截屏2021-12-02 上午1.11.13](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午1.11.13.png)

使用命令==`killall httpd`==关闭Apache进程。

使用命令==`/usr/local/apache/bin/apachectl -t`==检查Apache主配置是否有错。

使用命令==`/usr/local/apache/bin/apachectl`==开启Apache进程。

进入浏览器输入==192.168.158.2/phpinfo.php==进行检验，能打开则unix socket模式配置成功。

![截屏2021-12-02 上午1.12.55](/Users/lamchingkeung/Desktop/PHP_screenshot/截屏2021-12-02 上午1.12.55.png)





# 8、Wordpress的搭建与优化

## 8.1、Wordpress的搭建

### 8.1.1、Wordpress文件部署

使用命令==`wget https://wordpress.org/latest.tar.gz`==获取Wordpress的网站源码包。

![截屏2021-12-03 上午9.04.33](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.04.33.png)

使用命令==`tar -zxvf latest.tar.gz`==解压网站源码包

使用命令==`mkdir /usr/local/apache/htdocs/wordpress/`==在Apache网站目录下新建一个wordpress文件，用于存放Wordpress网站文件。

使用命令==`mv /root/wordpress/* /usr/local/apache/htdocs/wordpress/`==将解压下来的网站源码文件转移到apache网站文件目录下的wordpress文件夹。

使用命令==`chown www.www /usr/local/apache/htdocs/wordpress -R`==将apache网站文件目录下的wordpress文件夹以及子文件的所属和所属组改为www。

![截屏2021-12-03 上午9.06.57](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.06.57.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

==新增虚拟主机配置==，下列为配置参考：

```shell
<VirtualHost *:80>
#网站的跟目录
    DocumentRoot "/usr/local/apache/htdocs/wordpress"

#设置网站跟目录的权限
#Options Indexes FollowSymLinks，网站有index页面优先加载，允许使用链接文件
#AllowOverride None不允许使用权限复写
#Require all granted允许所有人访问网站根目录
<Directory "/usr/local/apache/htdocs/wordpress">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

#设置默认起始页面为index.php或index.html文件
<IfModule dir_module>
    DirectoryIndex index.php index.html
</IfModule>

#使用php-fpm unix socket模式
<FilesMatch "\.php$">
    # Unix sockets require 2.4.7 or later
    SetHandler  "proxy:unix:/usr/local/php/etc/php-fpm.socket|fcgi://localhost/"
</FilesMatch>

</VirtualHost>

```

==如果你的虚拟主机配置只有一项，对应配置可以分开写，如果你的虚拟主机有多项，则对应的配置要写进同一个虚拟主机配置内==。

![截屏2021-12-03 上午9.13.06](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.13.06.png)

![截屏2021-12-03 上午9.13.29](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.13.29.png)

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

### 8.1.2、Wordpress安装

使用命令==`/etc/init.d/mysql`==启动MySQL数据库。

使用命令==`mysql -u root -pyajyu114514`==以root用户登录MySQL数据库。

在MySQL内使用命令==`create database wordpress;`==创建一个名为wordpress的数据库，为后续网站的搭建做准备。

![截屏2021-12-03 上午9.15.04](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.15.04.png)

使用物理机或者虚拟机的浏览器，输入==192.168.158.2==，然后自动跳转到Wordpress的初始化界面，上来就让你选择语言。

![截屏2021-12-03 上午9.15.44](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.15.44.png)

==如果你对你的其他外语水平很有信息可以选择其他语言，选择好语言之后点击继续==

![截屏2021-12-03 上午9.16.00](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.16.00.png)

这些是安装前的一些提示，==这里可以不看，直接点击“现在就开始！”==。

![截屏2021-12-03 上午9.16.20](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.16.20.png)

前面在MySQL里创建的数据库为wordpress，这里==默认数据库名是wordpress==，==如果不是叫wordpress，请写入自己创建的数据库==。

用户名默认root，==密码填入你的MySQL的root密码==。

其他的选项默认不变。

填写完成后点击提交。

![截屏2021-12-03 上午9.16.44](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.16.44.png)

这一页是==用户注册界面==，==自定义天写站点标题，自定义填写你的用户名和密码，这个用户名和密码用于登录网站，其他选项根据自己的喜好选择是否填写==。

![截屏2021-12-03 上午9.19.08](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.19.08.png)

到了这个页面，安装完成，点击登录跳转到登录界面。

![截屏2021-12-03 上午9.19.25](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.19.25.png)

到了登录界面，==输入在安装界面设定的用户名和密码登录==。

![截屏2021-12-03 上午9.19.46](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.19.46.png)

使用管理员账户默认进入到了后台界面，试着写一篇博客试一下。

![截屏2021-12-03 上午9.20.16](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.20.16.png)

写完之后点击发布。

![截屏2021-12-03 上午9.23.27](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.23.27.png)

点击发布之后会提示你检查一些信息，如果确认无误，再次点击发布就能发布出去了

![截屏2021-12-03 上午9.23.43](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.23.43.png)



![截屏2021-12-03 上午9.23.54](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.23.54.png)

==直接输入服务器的IP==就可以进入到首页了，可以看到写的第一篇博客。

![截屏2021-12-03 上午9.24.32](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.24.32.png)

点进标题去查看详细。

![截屏2021-12-03 上午9.25.01](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午9.25.01.png)

如果想要发纯中文的文章

则需要在后台管理界面，点击设置——>固定链接，在里面选择朴素或者是文章名。

==如果选择了朴素，博客的链接结尾是"?p=xxx"==.

![截屏2021-12-03 上午10.38.10](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午10.38.10.png)

==如果选择了文章名的固定链接，则可以在发布时自定义URL别名==。

![截屏2021-12-03 上午10.38.55](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 上午10.38.55.png)

## 8.2、网站的简单优化

==如果一个真是的网站在上线前不做任何的优化，那么这个网站是很容易出事的，即便不出事故，体验也不会很好==。

以下将会介绍部分网站的简单优化。

### 8.2.1、优化连接

#### 8.2.1.1、长连接介绍

服务器==除了自身要稳==，还要==保障用户的体验==。

HTTP服务是基于==TCP协议的==。

大致的流程为：==TCP“三次握手”——>发起HTTP请求——>相应HTTP请求——>TCP“四次挥手”==。

TCP的“三次握手”和“四次挥手”，==能保证连接可靠，不过速度会相对变慢==。

==不做优化的话，每次点击一个网页内的东西都要进行TCP连接和TCP断开，如果是大型网站，那用户体验就会非常糟糕，对服务器也是相当不友好，很容易“双输”==。

这里就有一个很好的解决方案，那就是==设置长链接==。

当然， ==新版Apache默认开启长连接，可以根据需求来修改相关的参数==。

简单来说：==长连接设定就是在完成TCP“三次握手”之后，延长连接的时间，然后用户离开一段时间后关闭连接==。

==注意，长链接的持续时间需要根据实际情况来进行调整，持续时间太长太对服务器不友好，持续时间太短对用户体验不友好==。

#### 8.2.1.2、长连接的设置

在搭建好的网站打开开发者工具查看==响应标头==。

可以看到==Apache默认配置下长连接的保持时间100秒，长连接断开时间为5秒==。 

![截屏2021-12-03 下午2.16.38](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.16.38.png)

使用命令==`	vim /usr/local/apache/conf/extra/httpd-default.conf`==进入Apache的默认配置文件

```shell
#长链接设置是否打开
KeepAlive
#长链接保持时长设置，这个时长最好设置成10分钟左右。
MaxKeepAliveRequests 
#长链接断开时长设置，即用户离开网页多少秒后断开TCP连接，如果服务器比较好，这个值建议设置小一些。
KeepAliveTimeout
```

此处将长连接保持时间改成600（秒），长连接断开时长设为3（秒）。

![截屏2021-12-03 下午2.21.44](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.21.44.png)

然后使用命令==`vim /usr/local/apache/conf/httpd.conf`==打开Apache的主配置文件。

然后移动到487行，将==Include行==的代码注释去掉，==启用Apache默认配置文件==。

![截屏2021-12-03 下午2.22.47](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.22.47.png)

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

#### 8.2.1.3、长连接设置检验

重新打开搭建好的网站，打开开发者工具==查看响应标头==，可以看到长连接时间发生了改变，证明长连接配置成功。

![截屏2021-12-03 下午2.24.29](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.24.29.png)

### 8.2.2、添加静态缓存

用户每次访问网站都会==将页面的所有元素都下载一遍==，然后浏览器进行渲染。

但网站有==一些元素是在短时间内固定不变==，==如果网站很大，用户每次访问都要下载所有元素，这对用户体验不好，对服务器也不友好，所以需要配置静态缓存==。

静态缓存是指将一些==短时间内不会发生改变的数据下载到用户本地的磁盘中==，当用户==访问这些网站的时候，本地缓存就会作为加载的一部分==，这样就能==加快用户打开的速度，也能节约服务器的带宽==。

#### 8.2.2.1、开启静态缓存

使用命令==`vim /usr/local/apache/conf/httpd.conf`==打开Apache的主配置文件。

找到==`LoadModule expires_module modules/mod_expires.so`==语句前的==注释符==去掉。

![截屏2021-12-03 下午2.27.45](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.27.45.png)使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

将以下的内容==写进有关Wordpress虚拟主机的配置内==：

```shell
<IfModule expires_module>
#开启缓存
	ExpiresActive on
#针对不同类型元素设置缓存时间
#gif图保存1天
	ExpiresByType image/gif "access plus 1 days"
#jpg图片保存1天
	ExpiresByType image/jpeg "access plus 24 hours"
#png图片保存1天
	ExpiresByType image/png "access plus 24 hours"
#文字或css配置文件保存2小时
	ExpiresByType text/css "now plus 2 hours"
#javascript脚本保存2小时
	ExpiresByType application/x-javascript "now plus 2 hours" 
#flash文件保存两小时
	ExpiresByType application/x-shockwave-flash "now plus 2 hours” 
#其他数据不缓存
	ExpiresDefault "now plus 0 min"
</IfModule>
```

![截屏2021-12-03 下午2.31.46](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.31.46.png)

#### 8.2.2.2、测试静态缓存

此处使用图片做测试。

此处准备好一张图片，为图片自定义一个名字。

![截屏2021-12-03 下午2.36.25](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.36.25.png)

使用命令==`cp rinko.png /usr/local/apache/htdocs/wordpress`==将图片转移到网站根目录下

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

![截屏2021-12-03 下午2.34.31](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.34.31.png)

访问==192.168.158.2/rinko.png==网站下的跟目录下的图片。

图片成功打开，然后使用开发者工具查看响应标头。

可以看到==Cache-control （缓存控制时间）和 Expires（过期的具体时间）==。

其中Cache-control后有一个参数叫==max-age==，86400是1天时间，换算一下Expires里的具体时间，与配置相符，可以证明静态缓存配置成功。

![截屏2021-12-03 下午2.36.04](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.36.04.png)

### 8.2.3、网站数据压缩

数据从服务启传输到客户端，需要时间，==在保证用户体验的情况下，文件越大，就要求传输的速度要快==，所以==有一些数据是有必要压缩的==。

Apache 支持两种压缩，一种是==deflate==、一种是==gzip==。

在==Apache 1.x版本的时候，没有网页数据压缩==，所以==引进了第三方的mod_gzip==来执行网页数据压缩。

在==Apache 2.x版本的时候，加入了deflate_module来取代mod_gzip==

相同点：==都使用gzip压缩算法==。

不同点：==deflate_module压缩度略快，mod_gzip压缩率略高，mod_gzip属于第三方模块，需要消耗更多的服务器资源==。

所以在==需求比较高的服务器中使用deflate_module会比较好==。

#### 8.2.3.1、数据压缩的实现

此处我们==使用Apache自带的deflate_modlue==。

使用命令==`vim /usr/local/apache/conf/httpd.conf`==修改Apache主配置文件。

将108行==`LoadModule deflate_module modules/mod_deflate.so`==语句前的==注释符==去掉，表示==开启deflate_modlue==。

![截屏2021-12-03 下午2.39.18](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.39.18.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

将以下的内容==写进有关Wordpress虚拟主机的配置内==：

```shell
<IfModule deflate_module>
#压缩等级的设置，设数字越大，压缩越好，消耗CPU资源也就越大，要合理设置。
	DeflateCompressionLevel 4
#压缩文件类型：html、xml、php、css、js
	AddOutputFilterByType DEFLATE text/html text/plain text/xml application/x-javascript application/x-httpd-php
	AddOutputFilter DEFLATE js css
#浏览器为IE1~6,不设置压缩
	BrowserMatch \bMSIE\s[1-6] dont-vary
#设置不压缩的文件，分别是gif、jpeg、png、exe、tar.gz、zip、bz2、sit、rar、pdf、doc
	SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary
	SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
	SetEnvIfNoCase Request_URI .(?:pdf|doc)$ no-gzip dont-vary
</IfModule>
```

![截屏2021-12-03 下午2.49.49](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.49.49.png)

#### 8.2.3.2、测试数据压缩

使用命令==`vim deflate.sh`==新建一个Shell脚本。

写入以下内容：

```sh
#取/etc/passwd文件里1～30行的内容覆盖到wordpress网站跟目录下的defalte.html网站文件下
for i in `seq 1 30`;do
    cat /etc/passwd >> /usr/local/apache/htdocs/wordpress/deflate.html
done
```

![截屏2021-12-03 下午2.48.07](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.48.07.png)

使用命令==`chmod a+x deflate.sh`==给新创建的脚本==添加执行权==。

使用命令==`./deflate.sh`==调用脚本。

使用命令==`du -sh /usr/local/apache/htdocs/wordpress/deflate.html`==查看网页文件大小，可以看到这个网页大小==有192k==。

![截屏2021-12-03 下午2.48.49](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.48.49.png)

```sh
#du是一个用于显示每个文件和目录的磁盘使用空间的命令
#-s表示仅显示总计 -h为以人性化的形式显示文件大小
du -sh
```

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

然后在浏览器中访问==192.168.158.2/flate.html==查看新生成的网页，可以看到，这网站文件从==192k被压成了仅仅只有2.03kb==。

![截屏2021-12-03 下午2.55.05](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.55.05.png)

在响应标头中能看到==Accept-Encoding: gzip, deflate==，可以看到deflate模块打开成功，可以证明网站使用module_deflate实现数据压缩的配置成功。

![截屏2021-12-03 下午2.53.49](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午2.53.49.png)

### 8.2.4、网站限速

服务器除了能给用户提供网站服务，还能提供下载服务，~~比如不开会员限速很厉害的百度云盘~~。

==作为下载服务器使用时，要考虑服务器的带宽和IO性能==，所以需要==防范异常的下载请求==。

==“适当的”限速能让服务器能更好地运行，以便提供更好的服务==。

==带宽被占满了，访问速度非常慢甚至无法访问；IO满了，就没法处理用户请求甚至宕机==。

有两种办法来达到“限速”的效果：==直接限制下载速度==、==限制同一IP的连接数==。

#### 8.2.4.1、如果网站不做限速

使用命令==`mkdir /usr/local/apache/htdocs/wordpress/download`==在Wordpress网站根目录下创建一个名为download的文件夹。

使用命令==`dd if=/dev/zero of=/usr/local/apache/htdocs/wordpress/download/bigfile count=500 bs=1M`==在Wordpress网站根目录的download文件夹上创建大小为500个M、名字为bigfile的文件。

使用命令==`du -sh /usr/local/apache/htdocs/wordpress/download/bigfile`==查看新创建文件的大小，再次确认写入的文件为500M。

![截屏2021-12-03 下午3.20.02](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.20.02.png)

此处使用macOS物理机测试下载速度。

使用命令==`wget http:192.168.158.2/download/bigfile`==下载生成的bigfile文件，可以看到==该文件在内网的下载速度是146MB/s（本机硬盘最高读写速度为2000MB/S）==，如果有==多台机子同时使用这样的速度下载，即便是内网也吃不消==。

==所以限速很有必要！==

![截屏2021-12-03 下午3.20.53](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.20.53.png)

限速模块有：==ratelimit_module==、==mod_limitipconn==。

ratelimit_module是==Apache自带==的模块，用于==对单线程下载做下载速度限制==，所以==防不住多线程下载==。

mod_limitipconn是==第三方==的模块，用于==限制每个IP的连接数量==。

#### 8.2.4.2.、Apache自带模块ratelimit_module的配置与测试

使用命令==`vim /usr/local/apache/conf/httpd.conf`==打开Apache的主配置文件。

然后跳转到100行，将==`LoadMoudule ratelimit_module modules/mod_mod_ratelimit.so`==语句前的==注释符==去掉。

![截屏2021-12-03 下午3.22.00](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.22.00.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

将以下的内容==写进有关Wordpress虚拟主机的配置内==：

```shell
#对目录download进行设置
<Location /download>
 SetOutputFilter RATE_LIMIT#设置输出过滤器——速度限制
 SetEnv rate-limit 2048#将速度限制到2048k/s,即MB/s
</Location>
```

![截屏2021-12-03 下午3.23.44](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.23.44.png)

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

在macOS物理机使用命令==`wget http:192.168.158.2/download/bigfile`==下载生成的bigfile文件，可以看到==下载速度被限制在了2MB/S以内==，可以证明使用ratelimit_module限制下载速度的配置成功。

![截屏2021-12-03 下午3.24.26](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.24.26.png)

#### 8.2.4.3、第三方模块mod_limitipconn的下载、安装、配置与测试

##### 8.2.4.3.1、第三方模块mod_limitipconn的下载与安装

使用命令==`wget https://dominia.org/djao/limit/mod_limitipconn- 0.24.tar.bz2 --no-check-certificate`==下载第三方模块mod_limitipconn。

![截屏2021-12-03 下午3.28.46](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.28.46.png)

使用命令==`tar -jxvf mod_limitipconn-0.24.tar.bz2`==解压mod_limitipconn的源码包文件（此处是tar.bz2文件，所以是==用jx来解压而不是zx来解压==）。

使用命令==` cd mod_limitipconn-0.24`==进入源码包目录。

使用命令==` vim Makefile`==进入编译配置文件。

![截屏2021-12-03 下午3.30.35](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.30.35.png)

然后==修改APXS行和APACHECTL行的参数配置==，修改成如下所示：

```shell
APXS=/usr/local/apache/bin/apxs
APACHECTL=/usr/local/apache/bin/apachectl
```

![截屏2021-12-03 下午3.30.20](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.30.20.png)

然后使用命令==`make & make install`==安装mod_limitipconn。

![截屏2021-12-03 下午3.31.01](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.31.01.png)

##### 8.2.4.3.2、第三方模块mod_limitipconn的配置与测试

使用命令==`grep limitipconn /usr/local/apache/conf/httpd.conf`==查看Apache目录主配置文件==是否有安装该模块==，如果没有，则可能是安装出错，需要重新安装。

![截屏2021-12-03 下午3.31.48](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.31.48.png)



![截屏2021-12-03 下午3.35.39](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.35.39.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

将以下的内容==写进有关Wordpress虚拟主机的配置内==：

```shell
#对download目录进行设置
<Location /download>
 SetOutputFilter RATE_LIMIT #设置输出过滤器——速度限制
 SetEnv rate-limit  1024#限制下载速度为1024KB/s，即1MB/S
 MaxConnPerIP 3 #每个IP最大的连接数为3
 NoIPLimit index.htm #index.htm的访问没有IP限制
</Location>
```

![截屏2021-12-03 下午3.35.39](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.35.39.png)

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

在macOS物理机开启多个终端窗口，每个窗口使用命令==`wget http:192.168.158.2/download/bigfile`==下载生成的bigfile文件，可以看到==能进行下载的窗口的下载速度被限制在了1MB/S以内==，==不能进行下载的窗口返回503错误==，可以证明使用mod_limitipconn限制下载速度的配置成功。

![截屏2021-12-03 下午3.37.25](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午3.37.25.png)

### 8.2.5、网站访问限制

==公网网站一般不会做任何访问限制==。

==内网网站一般只有内部人能访问==。

比如==网站后台管理网站、公司数据站==等等，所以==需要设置访问控制指定IP或指定内部设备使用==。

#### 8.2.5.1、基于IP的网站限制的配置与测试

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

将以下的内容==写进有关Wordpress虚拟主机的配置内==：

```shell
#对Wordpress网站的download目录进行设置
<Directory "/usr/local/apache/htdocs/wordpress/download"> 
		AllowOverride None #不允许使用权限复写
    Require all denied #拒绝所有访问
    #这么设置是要达成除了192.168.158.1、127.0.0.1，拒绝其他IP的访问的目标
    Require ip 192.168.158.1
    Require host localhost 
</Directory>

```

![截屏2021-12-03 下午4.12.10](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午4.12.10.png)

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

然后在macOS物理机和另一台Linux虚拟机上：

分别使用命令==`wget https://dominia.org/djao/limit/mod_limitipconn- 0.24.tar.bz2 --no-check-certificate`==测试，可以看到，==macOS物理机能够顺利进行下载==，==Linux虚拟机返回403错误==。

证明基于IP的网站限制配置成功。

![截屏2021-12-03 下午4.11.24](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午4.11.24.png)

#### 8.2.5.1、基于用户与IP验证的网站限制的配置与测试

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

==将上一个实验的Directory配置注释==，将以下的内容==写进有关Wordpress虚拟主机的配置内==：

```shell
#对Wordpress网站的download目录进行设置
<Directory "/usr/local/apache/htdocs/htdocs/wordpress/download">
	#用户访问时提示信息，这里可以自定义填写信息
	AuthName "Private" 
	#认证类型选择Basic（http也只能选Basic，https有多种选择，比如MD5）
	AuthType Basic 
	#指定认证的文件为/usr/local/apache/目录下的user.dbm
	#user.dbm是一个存放了用户名和密码的文件
	AuthUserFile "/usr/local/apache/user.dbm" 
#允许所有人访问
<RequireAll>
  #允许AuthUserFile内写入的用户访问
	Require valid-user 
	#只有192.168.158.1不允许访问
	Require not ip 192.168.158.1 
</RequireAll>
</Directory>
```

![截屏2021-12-03 下午5.09.45](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午5.09.45.png)

使用命令==`/usr/local/apache/bin/htpasswd -cm /usr/local/apache/user.dbm gudako`==生成一个==用于密码认证==的文件。

```shell
#htpasswd是Apache软件创建密码认证文件的命令
#/usr/local/apache/bin/htpasswd表示调用apache目录下的bin目录里的htpasswd命令
#-c表示创建一个新文件，-m表示对密码使用MD5加密
#后续的目录为生成密码文件的目录
#最后一个参数是用户名
/usr/local/apache/bin/htpasswd -cm /usr/local/apache/user.dbm gudako
```

按照提示输入密码，然后使用命令==`cat /usr/local/apache/user.dbm`==，可以看到==生成的用户和使用MD5加密的密码==。

![截屏2021-12-03 下午5.01.55](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午5.01.55.png)

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

使用==macOS的浏览器打开http://192.168.158.2/download==，可以==看到直接返回403错误==。

![截屏2021-12-03 下午9.50.20](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午9.50.20.png)

使用==Linux虚拟机的浏览器打开http://192.168.158.2/download==，可以看到==需要账号和密码登录==。

![截屏2021-12-03 下午9.51.07](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午9.51.07.png)

==密码错误无法进入，密码正确可以进入==，证明使用Linux证明基于用户和IP的网站限制配置成功。

![截屏2021-12-03 下午9.51.29](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午9.51.29.png)

### 8.2.6、URL重写

URL重写能实现的功能有很多，比如==隐藏真实地址、实现URL跳转、防盗链、限制访问资源类型等等==。

例如：

==使用www.z.cn会跳转到www.amazon.cn（amazon.com是无法直接访问的，需要使用特殊代理后才可以访问）==。

==使用www.g.cn会跳转到www.google.cn（点击里面的页面可以进入到Google搜索，但是只能搜索，不能查看详细的搜索结果，比如你能搜索出YouTube但是不能进入搜索出来的YouTube）==。

使用==www.360buy.com会跳转到www.jd.com（京东早年的域名叫360buy，花了3000万买下了jd.com然后才改名的）==。

#### 8.2.6.1、URL重写的配置

使用命令==`vim /usr/local/apache/conf/httpd.conf`==打开Apache的主配置文件。

将154行==`LoadModule rewrite_module modules/mod_rewrite.so`==前的==注释符==去掉。

![截屏2021-12-03 下午11.51.04](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-03 下午11.51.04.png)

使用命令==`vim /usr/local/apache/conf/extra/httpd-vhosts.conf`==更改虚拟主机配置文件。

==将上次实验有关访问控制的配置注释掉==，将以下的内容==写进有关Wordpress虚拟主机的配置内==：

```shell
#开启URL反写引擎
RewriteEngine on 

#NC表示忽略大小写，L表示最后一条规则，F表示返回403 forbidden

#重写条件——若UA是firefox，则返回403 forbidden
RewriteCond %{HTTP_USER_AGENT} “firefox” [NC]
RewriteRule “^/$” - [F]

#重写条件——若UA是chrome，则返回百度网站
RewriteCond “%{HTTP_USER_AGENT}” “chrome” [NC]
RewriteRule "^/$" "https://www.baidu.com" [NC,L]
```

![截屏2021-12-05 上午6.26.16](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-05 上午6.26.16.png)

使用命令==`kill httpd`==关闭Apache。

使用命令==`usr/local/apache/bin/apachectl -t`==测试Apache的配置文件是否出错。

使用命令==`usr/local/apache/bin/apachectl`==启动Apache。

#### 8.2.6.2、URL重写的测试

==此处使用Brup Suite抓包配合验证==。

使用safari浏览器，==将UA设置safari==，访问192.168.158.2，可以看到正常返回Wordpress网站，==状态码为200==。

![截屏2021-12-04 上午2.41.56](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-04 上午2.41.56.png)

使用safari浏览器，==将UA设置chrome==，访问192.168.158.2，可以看到网站重定到www.biadu.com，==状态码为302==。

![截屏2021-12-04 上午2.42.37](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-04 上午2.42.37.png)

使用safari浏览器，==将UA设置firefox==，访问192.168.158.2，可以看到返回的Forbidden，==状态码为403==。

![截屏2021-12-05 上午6.29.30](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-05 上午6.29.30.png)



### 8.2.7、Apache模块相关的提示

Apache是一个“补丁服务器”，在安装的时候就==有很多模块供用户使用==。

==但在生产环境中，有很多模块是没有用的==，我们==根据实际的需求==，然后==在Apache主配置文件中保留需要的模块，将不需要的模块全部注释掉==，从而达到节省服务器资源。

有什么模块？这些模块有什么功能？我该怎么用？这里给出Apache的官方指导：

==Apache官方模块介绍==：https://httpd.apache.org/docs/2.4/zh-cn/mod/ ==

==Apache官方指令快速索引==：https://httpd.apache.org/docs/2.4/zh-cn/mod/quickreference.html

## 8.3、简单的网站压力测试

Apache在安装后会提供一个压力测试用的命令，名为==`ab`==。

以下使用对本机进行压力测试为例子：

使用命令==`ab -n 100 -c 100 http://192.168.158.2 `==对本机进行一个简单的压力测试

```shell
#-n为请求数量
#-c为并发数
#所以这一条命令是模拟10并发的情况下，完成100次访问
ab -n 100 -c 10 http://192.168.158.2
```

![截屏2021-12-04 上午2.51.04](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-04 上午2.51.04.png)

其中有几个比较重要的指标：

```java
/*
吞吐率
Requests per second：3.56
测试总耗时
Time taken for tests：28.067
请求失败数目
Failed requests：0
用户等待时间
Time per request：2806.682
服务器平均请求等待时间
Time per request:across all concurrent requests：280.668
*/
```

![截屏2021-12-04 上午2.51.13](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-04 上午2.51.13.png)

![截屏2021-12-04 上午2.51.22](/Users/lamchingkeung/Desktop/Wordpress_screenshot/截屏2021-12-04 上午2.51.22.png)

以上是本机的压力测试，==以下是对大厂服务器的压力测试，没有对比就没有伤害==。

```java
/*
吞吐率
Requests per second：9637.11
测试总耗时
Time taken for tests：1.196
请求失败数目
Failed requests：95
用户等待时间
Time per request：1195.976
服务器平均请求等待时间
Time per request:across all concurrent requests：11.960
*/
```

![image-20211205071351290](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211205071351290.png)



# 9、Nginx的安装与启动测试（未完待续）

## 9.1、Nginx的介绍

Nginx，读作“Engine X”，是一款是由俄罗斯程序员Igor Sysoev开发高性能的 Web和反向代理服务器软件。

==Nginx是Apache老牌竞争对手==。

Nginx的优点：==性能优异，高度模块化设计，模块编写简单，配置文件简洁==。

==在高并发和静态情况下，Nginx表现优于Apache==。

Nginx的目标就是要超越Apache，到了今年，Nginx在使用人数上超越了Apache。

根据W3Techs网的统计，==截止至2021年12月4日，W3Techs所能查到的WEB服务器中，使用最多的服务器软件为Nginx（即便服务器有多种服务器服务器软件）==。

![image-20211205072628892](/Users/lamchingkeung/Library/Application Support/typora-user-images/image-20211205072628892.png)

## 9.2、Nginx的安装

#### 9.2.1、Nginx源码包的下载

进入网站https://nginx.org，==点击download==。

![截屏2021-12-04 上午2.52.49](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午2.52.49.png)



在Mainlin Version中，==选择nginx-1.21.4==。

==此处可以选择在虚拟机使用`wget`命令安装，也可以直接下载源码包再拖到虚拟机上==。

![截屏2021-12-04 上午2.53.18](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午2.53.18.png)

此处在虚拟机上使用==`wget http://nginx.org/download/nginx-1.21.4.tar.gz /usr/src`==，将Nginx源码包下载到/usr/src/目录下

![截屏2021-12-04 上午2.57.59](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午2.57.59.png)

使用命令==`cd /usr/src`==进入src目录，使用命令==`ls`==确认Nginx源码包下载到了该目录下。

![截屏2021-12-04 上午2.58.12](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午2.58.12.png)

#### 9.2.2、Nginx源码包安装

使用==`yum -y install gcc pcre-devel zlib-devel`==安装Nginx依赖包，==也可以检测是否已经安装这些依赖包==。

![截屏2021-12-04 上午2.58.38](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午2.58.38.png)

使用命令==`tar -zxvf nginx-1.19.3.tar.gz`==解压Nginx源码包。

使用命令==`cd nginx-1.19.3/`==进入源码包目录。

使用命令==`./configure --prefix=/usr/local/nginx`==检查环境是否能安装并提前将安装目录设为/usr/local/nginx。

![截屏2021-12-04 上午2.59.34](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午2.59.34.png)

使用命令==`make &make install`==进行编译安装Nginx。

![截屏2021-12-04 上午3.00.24](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午3.00.24.png)

## 9.3、Nginx启动测试

==如果开启了Apache，请关闭Apache！==

使用命令==`killall httpd`==关闭Apache，使用命令==`lsof -i 80`==检查80端口是否被Apache占用。

使用命令==`/usr/local/nginx/sbin/nginx`==启动nginx

使用==`elinks http://192.168.158.2 --dump`==进入本地页面，==如果能看到Nginx的欢迎界面，则证明Nginx安装成功==。

使用命令==`lsof -i :80`==，可以看到有两个Nginx的进程占用了80端口。

使用命令==`killall –s QUIT nginx`==关闭Nginx

![截屏2021-12-04 上午3.03.16](/Users/lamchingkeung/Desktop/nginx_screenshot/截屏2021-12-04 上午3.03.16.png)





